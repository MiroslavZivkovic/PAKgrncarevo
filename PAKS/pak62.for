C=======================================================================
C   SUBROUTINE KTPG 
C              READE6
C              SISTT6
C              ELTE6
C              MEL611
C              MEL631
C=======================================================================
      SUBROUTINE KTPG
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CE     STIFFNES MATRIX CALCULATION FOR THINWALLED BEAM
C
      include 'paka.inc'
      
      COMMON /DUZINA/ LMAX,MTOT,LMAXM,LRAD,NRAD
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /ELEMAE/ MXAE,LAE,LMXAE,LHE,LBET,LBED,LRTHE,LSKE,LLM
      COMMON /ELEMA6/ MXAU,LAU,LLMEL,LNEL,LNMAT,LCTR,LMGLV,LLUV,LINDPR,
     1                LELKG,LNAPGV,LPRR,LNTIPG
      COMMON /DUPLAP/ IDVA
C
      NULL=0
      LAU=LMAX
      CALL READE6(A(LAU),NULL)
      CALL DELJIV(LMAX,2,INDL)
      IF(INDL.EQ.0) LMAX=LMAX+1
      LAE=LMAX
      NCVE6=NCVE*6
      NN6 = NCVE6*NCVE6
      MXAE = NCVE6+(2*NN6+NCVE6*(NCVE6+1)/2)*IDVA
      LMAX = LAE + MXAE
      IF(LMAX.LT.MTOT) GO TO 70
      WRITE(IZLAZ,2009) LMAX,MTOT
 2009 FORMAT(///' NEDOVOLJNA DIMENZIJA U VEKTORU A ZA MATRICE ELEMENATA'
     1/' POTREBNA DIMENZIJA, LMAX=',I10/
     2' RASPOLOZIVA DIMENZIJA, MTOT=',I10)
      STOP
C
C     STIFFNES MATRIX CALCULATION
C
   70 CALL SISTT6(A(LAE),A(LAU))
C
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE READE6(AU,INA)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    GLAVNI UPRAVLJACKI PROGRAM ZA UCITAVANJE ULAZNIH PODATAKA U AU
CE    MAIN CONTROLL PROGRAM FOR DATA READING IN AU VECTOR
C
      include 'paka.inc'
      
      COMMON /ELEMA6/ MXAU,LAU,LLMEL,LNEL,LNMAT,LCTR,LMGLV,LLUV,LINDPR,
     1                LELKG,LNAPGV,LPRR,LNTIPG
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /CVOREL/ ICVEL,LCVEL,LELCV,NPA,NPI,LCEL,LELC,NMA,NMI
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /DUZINA/ LMAX,MTOT,LMAXM,LRAD,NRAD
      COMMON /DUPLAP/ IDVA
      COMMON /PLASTI/ LPLAST,LPLAS1,LSIGMA
      COMMON /ZAPISI/ LSTAZA(5)
C
      COMMON /TRAN/ X1,Y1,Z1,X2,Y2,Z2,DUZ,TRR(3,3),AKOR(4)
      COMMON /COMPRF/ YC,ZC,YI,ZI,ALFB,TK,CAPAY,CAPAZ,AREA,POVR,YM,ZM,
     1                DDELT,YP,SWO(1),OM(1),DELTAP(3),TAUTK(3),OY,OZ,
     2                NT,NELM,NTIP,NKAR,IND,INDRPR(3),KR1,NEXTR,NPRPR
      COMMON /PGREDC/ NPUN,NPRBR,MAXPRR,NPRES,ICV1,ICV2,MATG,
     1                NKARD,MG,NVR,NWRITE,NAPG,INDOF
      COMMON /ITERBR/ ITER
      COMMON /RESTAR/ TSTART,IREST
      COMMON /LUCGRE/ ILU,ICP
      COMMON /BTHDTH/ INDBTH,INDDTH,LTBTH,LTDTH
C
      DIMENSION AU(*),IA(1)
      REAL AU
      EQUIVALENCE (A(1),IA(1))
CS    POZIVANJE PROGRAMA ZA ULAZNE PODATKE .
CE    CALL SUBROUTINE FOR DATA READING
      LSTAZA(1)=LMAX8
      READ(IELEM,REC=LMAX8)
     1 NCVE,MXAU,LNEL,LNMAT,LNTIPG,LCTR,LMGLV,LLUV,LINDPR,LELKG,
     2 LNAPGV,LPRR,LCEL,LELC,NMA,NMI,
     3 YC,ZC,YI,ZI,ALFB,TK,CAPAY,CAPAZ,YM,ZM,AREA,POVR,DDELT,YP,
     1 OY,OZ,(DELTAP(I),I=1,3),(TAUTK(I),I=1,3),(AKOR(I),I=1,4),
     2 NT,NELM,NTIP,NKAR,KR1,NEXTR,NPRPR,INDOF,ILU,ICP,
     1 INDBTH,INDDTH,LTBTH,LTDTH
C
      LSTAZA(2)=LMAX8+1
      CALL READDD(AU(LNEL),MXAU/IDVA,IELEM,LMAX8,LDUZI)
      LMAX=LAU+MXAU
      CALL DELJIV(LMAX,2,INDL)
      IF(INDL.EQ.0) LMAX=LMAX+1
      IF(IATYP.EQ.0) GO TO 10
CS....  PLASTICNOST
CE      PLASTICITY
C      IF(NMODM.LE.4.OR.NMODM.GT.8) GO TO 10
CS....  VELICINE NA KRAJU PRETHODNOG KORAKA
      LPLAST=LMAX
      NPROS =NE*25+2
      LPLAS1=LPLAST+NPROS*IDVA
CS....  VELICINE ZA TEKUCI KORAK
      NPROS1=NE*25+2
      LMAX  =LPLAS1+NPROS1*IDVA
      IF(LMAX.GT.MTOT) CALL ERROR(1)
      LSTAZA(3)=LMAX8+1
      CALL READDD(A(LPLAST),NPROS,IELEM,LMAX8,LDUZI)
      LSTAZA(4)=LMAX8+1
      CALL READDD(A(LPLAS1),NPROS1,IELEM,LMAX8,LDUZI)
      LSTAZA(5)=LMAX8+1
      LMAX8=LMAX8+LSTAZA(5)-LSTAZA(4)
C  1)... NIJE LINE-SEARCH , BEZ I SA RESTARTOM
      IF(ITER.NE.IA(LPLAS1))THEN
        IF(IREST.NE.1)THEN
          LMA8=LSTAZA(3)-1
          CALL WRITDD(A(LPLAS1),NPROS,IELEM,LMA8,LDUZI)
          CALL READDD(A(LPLAST),NPROS,IELEM,LMA8,LDUZI)
C          CALL JEDNA1(A(LPLAST),A(LPLAS1),NPROS)
        ELSE
          LMA8=LSTAZA(5)-1
          CALL READDD(A(LPLAST),NPROS1,IELEM,LMA8,LDUZI)
          LMA8=LSTAZA(3)-1
          CALL WRITDD(A(LPLAST),NPROS,IELEM,LMA8,LDUZI)
        ENDIF
      ENDIF
      IA(LPLAS1)=ITER
      RETURN
C
   10 LSIGMA=LMAX
      LPLAST=LSIGMA
      LPLAS1=LSIGMA
      NPROS=12*NE
      LMAX=LSIGMA+NPROS*IDVA
      IF(LMAX.GT.MTOT) CALL ERROR(1)
      LSTAZA(5)=LMAX8+1
      CALL READDD(A(LSIGMA),NPROS,IELEM,LMAX8,LDUZI)
C 
      RETURN
      END
C======================================================================
      SUBROUTINE SISTT6(AE,AU)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C     GLAVNI UPRAVLJACKI PROGRAM  ZA MATRICE ELEMENATA I SISTEMA(KCAL=1)
C
      include 'paka.inc'
      
      COMMON /REPERI/ LCORD,LID,LMAXA,LMHT
      COMMON /SISTEM/ LSK,LRTDT,NWK,JEDN,LFTDT
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /PLASTI/ LPLAST,LPLAS1,LSIGMA
      COMMON /ELEMA6/ MXAU,LAU,LLMEL,LNEL,LNMAT,LCTR,LMGLV,LLUV,LINDPR,
     1                LELKG,LNAPGV,LPRR,LNTIPG
      COMMON /ELEMAE/ MXAE,LAE,LMXAE,LHE,LBET,LBED,LRTHE,LSKE,LLM
      COMMON /ELEMEN/ ELAST(6,6),XJ(3,3),ALFA(6),TEMP0,DET,NLM,KK
      COMMON /ITERAC/ METOD,MAXIT,TOLE,TOLS,TOLM,KONVE,KONVS,KONVM
      COMMON /PERKOR/ LNKDT,LDTDT,LVDT,NDT,DT,VREME,KOR
      COMMON /ZAPISI/ LSTAZA(5)
      COMMON /DUPLAP/ IDVA
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /UPRIRI/ LUPRI
      COMMON /MATERM/ LMODEL,LGUSM
      COMMON /ITERBR/ ITER
      COMMON /ZAPSIL/ UBXYZ(3,10),NVFUB(10),INDZS,LZAPS,LNPRZ
      COMMON /TEMPCV/ LTECV,ITEMP
      COMMON /SRPSKI/ ISRPS
      COMMON /LUCGRE/ ILU,ICP
      COMMON /PRITGR/ LPRCV
      COMMON /BTHDTH/ INDBTH,INDDTH,LTBTH,LTDTH
C
      DIMENSION AE(*),AU(*)
      REAL AE,AU
C
CS    REPERI U VEKTORU ELEMENATA A
CE    LOCATIONS IN VECTOR A
C
      LUTT=LPLAST+2*IDVA
      LFTT=LUTT+NE*12*IDVA
      LTGT=LFTT+NE*12*IDVA
      LUT1=LPLAS1+2*IDVA
      LFT1=LUT1+NE*12*IDVA
      LTG1=LFT1+NE*12*IDVA
      IF(IATYP.EQ.0) LFT1=LSIGMA
C      CALL IWRR(A(LPLAST),4,'ITER')
C      CALL WRR(A(LFTT),NE*12,'FTT ')
C      CALL WRR(A(LUTT),NE*12,'UTT ')
C      CALL IWRR(A(LPLAS1),4,'ITE1')
C      CALL WRR(A(LFT1),NE*12,'FT1 ')
C      CALL WRR(A(LUT1),NE*12,'UT1 ')
C
CS    REPERI U VEKTORU ELEMENATA AE
CE    LOCATIONS IN VECTOR AE
C
      NCVE6=12
      NWE=NCVE6*(NCVE6+1)/2
      NN6 = NCVE6*NCVE6
      LSQ=1
      LSKG=LSQ+NN6*IDVA
      LSKE=LSKG+NN6*IDVA
      LLM=LSKE+NWE*IDVA
      MXAE1=LLM+NCVE6
      IF(MXAE1.EQ.MXAE+1)GO TO 30
      WRITE(IZLAZ,2010)MXAE1,MXAE
 2010 FORMAT(/' ','NE POKLAPAJU SE MXAE1 I MXAE'/2I10)
      STOP 'SISTT6'
C
CS    OSNOVNA PETLJA PO ELEMENTIMA
CE    BASIC LOOP OVER ALL ELEMENTS IN GROUP
C
   30 CONTINUE
      GRMAS=0.D0
      GRZAP=0.D0
      DO 100 NLM=1,NE
C
CS       NASTAJANJE I NESTAJANJE ELEMENATA
CE       ELEMENT BIRTH AND DEATH OPTION
CE          LTBTH: POINTER FOR TIME OF ELEMENT BIRTH
CE          LTDTH: POINTER FOR TIME OF ELEMENT DEATH
CE          VREME: CURRENT TIME
CE          NLM:   CURRENT ELEMENT
CE          IBD:   INDICATOR FOR EXISTENCE OF ELEMENT (=0-YES; =1-NO)
C
         IBD=0
         CALL DTHBTH(AU(LTBTH),AU(LTDTH),VREME,NLM,IBD)
         IF(IBD.EQ.1) GO TO 100
C         
      IZBR=MXAE/IDVA
      CALL CLEAR(AE,IZBR)
C
CS     RACUNANJE MATRICE ELEMENATA I/ILI NAPONA
CE     STIFFNES MATRIX CALCULATION AND/OR STRESS
C
       IF(ILU.EQ.1)THEN
      CALL ELTE6L (A(LID),A(LCORD),AU(LNEL),AU(LNTIPG),
     1 AU(LCTR),AU(LMGLV),AU(LLUV),A(LGUSM),AE(LSQ),
     2 AE(LSKG),AE(LSKE),AE(LLM),A(LFT1),A(LFTDT),A(LRTDT),
     3 A(LUTT),A(LFTT),A(LUT1),A(LFT1),A(LZAPS),A(LNPRZ),
     4 INDZS,NCVE6,GRZAP,GRMAS,A(LTG1),A(LTECV),A(LPRCV))
	GO TO 666
	  ENDIF
      CALL ELTE6 (A(LID),A(LCORD),AU(LNEL),AU(LNTIPG),
     1 AU(LCTR),AU(LMGLV),AU(LLUV),AU(LPRR),A(LGUSM),AE(LSQ),
     2 AE(LSKG),AE(LSKE),AE(LLM),A(LFT1),A(LFTDT),A(LRTDT),
     3 A(LUTT),A(LFTT),A(LTGT),A(LUT1),A(LFT1),A(LTG1),
     4 A(LZAPS),A(LNPRZ),INDZS,NCVE6,GRZAP,GRMAS,A(LTECV),A(LPRCV))
C      CALL WRR(A(LFTDT),JEDN,'FTDT')
C
CS    PAKOVANJE MATRICA ELEMENATA U MATRICU SISTEMA
CE    ADDING ELEMENT STIFFNES MATRIX TO GLOBAL STRUCTURE MATRIX
C
 666     IF(ISKNP.EQ.2) GO TO 100
C
      CALL SPAKUJ(A(LSK),A(LMAXA),AE(LSKE),AE(LLM),NCVE6)
  100 CONTINUE
      IF(ITER.EQ.0.AND.INDZS.GT.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2000) NGE,GRZAP,NGE,GRMAS
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6000) NGE,GRZAP,NGE,GRMAS
      ENDIF
C      CALL IWRR(A(LPLAS1),4,'ITE1')
C      CALL WRR(A(LFT1),NE*12,'FT1 ')
C      CALL WRR(A(LUT1),NE*12,'UT1 ')
C
      IF(IATYP.EQ.0) GO TO 110
      NPROS=NE*25+2
      LMA8=LSTAZA(4)-1
      CALL WRITDD(A(LPLAS1),NPROS,IELEM,LMA8,LDUZI)
      RETURN
C      IF(NMODM.LE.4) GO TO 110
C
  110 NPROS=12*NE
      LMA8=LSTAZA(5)-1
      CALL WRITDD(A(LSIGMA),NPROS,IELEM,LMA8,LDUZI)
      RETURN
C-----------------------------------------------------------------------
 2000 FORMAT(///
     111X,'GRUPA ELEMENATA',I5,' ZAPREMINA =',1PD12.5/
     111X,'GRUPA ELEMENATA',I5,'      MASA =',1PD12.5)
C-----------------------------------------------------------------------
 6000 FORMAT(///
     111X,'ELEMENT GROUP',I5,' VOLUME =',1PD12.5/
     111X,'ELEMENT GROUP',I5,'   MASS =',1PD12.5)
C-----------------------------------------------------------------------
      END
C=======================================================================
      SUBROUTINE ELTE6(ID,CORD,NEL,NTIPG,CTR,MGLV,LUV,PR,GUSM,
     1 SQ,SKG,SKE,LM,FE,FTDT,RTDT,UTT,FTT,TGT,UT1,FT1,TG1,ZAPS,NPRZ,
     2 INDZS,NCVE6,GRZAP,GRMAS,TECV,PRCV)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    OVAJ PODPROGRAM SLUZI ZA FORMIRANJE MATRICE KRUTOSTI 12X12
CS    LINIJSKOG ELEMENTA TANKOZIDNE GREDE
CE    ELEMENT STIFFNES MATRIX CALCULATION 
C
      include 'paka.inc'
      
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /GRUPEE/ NGEL,NGENL,LGEOM,NGEOM,ITERM
      COMMON /ITERAC/ METOD,MAXIT,TOLE,TOLS,TOLM,KONVE,KONVS,KONVM
      COMMON /PERKOR/ LNKDT,LDTDT,LVDT,NDT,DT,VREME,KOR
      COMMON /REPERM/ MREPER(4)
      COMMON /TEMPCV/ LTECV,ITEMP
      COMMON /PLASTI/ LPLAST,LPLAS1,LSIGMA
      COMMON /ANALIZ/ LINEAR,ITERGL,INDDIN
      COMMON /ELEMEN/ ELAST(6,6),XJ(3,3),ALFA(6),TEMP0,DET,NLM,KK
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /DIREKT/ LSTAZZ(9),LDRV0,LDRV1,LDRV,IDIREK
      COMMON /ITERBR/ ITER
C
      COMMON /PAKDFL/ IND16,IR16,IND40,IND49,IND69,IND99
      COMMON /PGREDG/ ELCON(3),EE,PNE,G
      COMMON /PGREDC/ NPUN,NPRBR,MAXPRR,NPRES,ICV1,ICV2,MATG,
     1                NKARD,MG,NVR,NWRITE,NAPG,INDOF
      COMMON /COMPRF/ YC,ZC,YI,ZI,ALFB,TK,CAPAY,CAPAZ,AREA,POVR,YM,ZM,
     1                DDELT,YP,SWO(1),OM(1),DELTAP(3),TAUTK(3),OY,OZ,
     2                NT,NELM,NTIP,NKAR,IND,INDRPR(3),KR1,NEXTR,NPRPR
      COMMON/TRAN/X1,Y1,Z1,X2,Y2,Z2,DUZ,TRR(3,3),AKOR(4)
      COMMON /RAPRES/ MCOR,MELM,MCORK,MNNKAR,MNBROJ,MSTEX,MSZ,MSY,MEL,
     1                MCSI,MEXC,MSEX,MINDI,MDV,MELV,MKT,MPRRMX
      COMMON /LUCGRE/ ILU,ICP
      DIMENSION ID(NP,*),CORD(NP,*),NEL(NE,*),NTIPG(NE,*),GUSM(50,*),
     1CTR(NE,*),MGLV(*),LUV(NE,*),ZAPS(*),NPRZ(*),PR(*),TECV(*),PRCV(*)
C
      DIMENSION SQ(NCVE6,*),SKG(NCVE6,*),LM(*),SKE(*),FE(12,*),
     1 FTDT(*),RTDT(*),UTT(12,*),FTT(12,*),UT1(12,*),FT1(12,*),
     2 U(12),R1(12),TRR2(3,3,2),FOF(12),TG1(*),TGT(*)
C
C      SQRT(X)=DSQRT(X)
C      WRITE(3,*)'POVR,IY,IZ,TK,ALFB,OY,OZ',POVR,YI,ZI,TK,ALFB,OY,OZ
      NSZM = 0
      NVERT = 0
      NPUN = 0
      PI = 1.
      PI = 4.*DATAN(PI)
C
CS    ODREDITI BROJEVE CVOROVA I KARAKTERISTIKE ELEMENTA
CE    NODE NUMBERS
      ICV1=NEL(NLM,1)
      ICV2=NEL(NLM,2)
C
      DO 100 I=1,6
      LM(I)=ID(ICV1,I)
  100 LM(I+6)=ID(ICV2,I)
C
      X1=CORD(ICV1,1)
      Y1=CORD(ICV1,2)
      Z1=CORD(ICV1,3)
      X2=CORD(ICV2,1)
      Y2=CORD(ICV2,2)
      Z2=CORD(ICV2,3)
      X12 = X1 - X2
      Y12 = Y1 - Y2
      Z12 = Z1 - Z2
      DUZ=DSQRT(X12*X12 + Y12*Y12 + Z12*Z12)
C
C     IF(MATG.GT.1) GO TO 157
C     IF(NLM.GT.1) GO TO 991
C     MAT = 1
C     GO TO 156
C 157 MAT = NTIPG(NLM,2)
      MAT = NTIPG(NLM,2)
C     IF(NLM.EQ.1) GO TO 155
C     IF(MAT.EQ.IMATS) GO TO 991
C 155 IMATS = MAT
C 156 CONTINUE
C      NMODM=1
      IF(ITERME.NE.0) TG1(NLM)=(TECV(ICV1)+TECV(ICV2))/2.D0
      GO TO (1,991,2,991,991,991,991,991),NMODM
    1 LFUN=MREPER(1)
      CALL MEL611(A(LFUN))
      GO TO 991
    2 LFUN=MREPER(1)
      LNTA=MREPER(2)
      LTEM=MREPER(3)
      MATE=MREPER(4)
      CALL MEL631(A(LFUN),A(LNTA),A(LTEM),MATE,TG1(NLM))
      GO TO 991
  991 CONTINUE
C
      G=EE/(2.D0*(1.D0+PNE))
      GUST=GUSM(NMODM,MAT)
      ZAPRE=DUZ*POVR
      AMASA=GUST*ZAPRE
      AMAS2=AMASA*.5
         IF(ITER.EQ.0.AND.INDZS.GT.0) THEN
            GRZAP=GRZAP+ZAPRE
            GRMAS=GRMAS+AMASA
         ENDIF
C        RASPOREDJIVANJE KONCENTRISANIH MASA U VEKTOR ZAPS
         IF(ITER.EQ.0.AND.INDZS.GT.0)THEN
            DO 500 I=1,2
            I6=(I-1)*6
            DO 500 K=1,3
               NJ=LM(I6+K)
               IF(NJ.GT.0) THEN
                  NPRNJ=NPRZ(NJ)
                  IF(NPRNJ.GT.0.AND.NPRNJ.NE.K) STOP 'NPRNJ'
                  NPRZ(NJ)=K
                  ZAPS(NJ)=ZAPS(NJ)+AMAS2
               ENDIF
  500       CONTINUE
         ENDIF
C
CS    ODREDIVANJE MATRICE TRANSFORMACIJE TR
CE    TRANSFORMATION MATRIX
C
      CALL TRANG (CTR,NE,U,NLM,1)
C.. TRANSFORMACIJE ZA LOKALNE ROTACIJE
      CALL CLEAR(TRR2,18)
      CALL TRANG2(A(LDRV),A(LDRV1),TRR2(1,1,1),ICV1,NP)
      CALL TRANG2(A(LDRV),A(LDRV1),TRR2(1,1,2),ICV2,NP)
C
CS     POMERANJA U LOKALNOM SISTEMU
CE     LOCAL DISPLACEMENTS
C
      DO 301 I=1,12
      R1(I)=0.D0
      IBR=LM(I)
  301 IF(IBR.GT.0) R1(I)=RTDT(IBR)
      DO 371 II=1,3
      U(II)=R1(II)
      U(II+6)=R1(II+6)
      U(II+3)=0.D0
  371 U(II+9)=0.D0
C.. TRANSFORMACIJA ROTACIJA IZ CVORNOG LOKALNOG SISTEMA NA GLOBALNI
      KK=3
      DO 503 L=1,2
       DO 502 II=1,3
       DO 502 JJ=1,3
  502  U(II+KK)=U(II+KK)+TRR2(II,JJ,L)*R1(JJ+KK)
      KK=9
  503 CONTINUE
      DO 506 II=1,12
  506 R1(II)=U(II)
C.. TRANSFORMACIJA NA GREDNI LOKALNI SISTEM U TRENUTKU "0"
      KK=0
      DO 383 L=1,2
      DO 384 II=1,3
      U(II+KK)=0.D0
      U(II+KK+6)=0.D0
      DO 384 JJ=1,3
      U(II+KK)=U(II+KK)+TRR(II,JJ)*R1(JJ+KK)
  384 U(II+KK+6)=U(II+KK+6)+TRR(II,JJ)*R1(JJ+KK+6)
      KK=3
  383 CONTINUE
C
C....  DOPUNSKA TRANSFORMACIJA ZBOG GEOMETRIJSKE NELINEARNOSTI
C
      IF(IATYP.EQ.2.OR.IATYP.EQ.3)THEN
        CALL TRANG (CTR,NE,U,NLM,2)
C
C....  PRIRASTAJI POMERANJA
C
      DO 385 II=1,12
        UT1(II,NLM)=R1(II)
  385   R1(II)=R1(II)-UTT(II,NLM)
C..    TRANSFORMACIJA PRIRASTAJA POMERANJA NA 
C      GREDNI LOKALNI SISTEM U TRENUTKU "T+DT"
        KK=0
        DO 387 L=1,2
         DO 386 II=1,3
          U(II+KK)=0.D0
          U(II+KK+6)=0.D0
          DO 386 JJ=1,3
           U(II+KK)=U(II+KK)+TRR(II,JJ)*R1(JJ+KK)
  386      U(II+KK+6)=U(II+KK+6)+TRR(II,JJ)*R1(JJ+KK+6)
         KK=3
  387   CONTINUE
      ENDIF
C
CS    LINEARNA MATRICA KRUTOSTI
CE    LINEAR STIFFNES MATRIX
C
      CALL SEL6(SQ,DUZ,POVR,YI,ZI,TK,EE,G,CAPAY,CAPAZ,OY,OZ)
C   
C  KOREKCIJA MATRICE SQ AKO IMA SLOBODNIH POMERANJA
      IF(MG.EQ.0) GO TO 110
      IF(MG.EQ.2) GO TO 111
C  VEZE ZGLOBNE U SVIM CVOROVIMA
      NBRS=0
      DO 112 IJ=1,2
      DO 113 I=4,6
      DO 113 J=1,12
  113 SQ(I+NBRS,J)=0.D0
      DO 114 J=4,6
      DO 114 I=1,12
  114 SQ(I,J+NBRS)=0.D0
      NBRS=6
  112 CONTINUE
      GO TO 110
C  SLOBODNA NEKA POMERANJA U LOKALNOM SISTEMU
  111 IF(MGLV(NLM).EQ.0) GO TO 110
      DO 115 I=1,12
      IF(LUV(NLM,I).EQ.0) GO TO 115
      DO 116 J=1,12
  116 SQ(I,J)=0.D0
      DO 117 J=1,12
  117 SQ(J,I)=0.D0
  115 CONTINUE
  110 CONTINUE
C
CS     RACUNANJE UNUTRASNJIH SILA U LOKALNOM SISTEMU
CE     INTERNAL FORCES CALCULATIN
C
CS.....   RACUNANJE TERMICKIH DEFORMACIJA - ETH; ETH=ALFA*(T-T0)
CE        THERMAL  STRAINS
      IF(ITERME.EQ.0) GO TO 103
      TG0=TEMP0
      IF(KOR.GT.1) TG0=TGT(NLM)
      FTERM=ALFA(1)*(TG1(NLM)-TG0)*EE*POVR
  103 CONTINUE
      IF(ISKNP.EQ.0.OR.ISKNP.EQ.2) THEN
       IF(IATYP.NE.0)THEN
        DO 404 II=1,12
        R1(II)=0.D0
        FOF(II)=FTT(II,NLM)
      IF(ITERME.EQ.0.OR.ITER.GT.0) GO TO 404
        IF(II.EQ.1) FOF(II)=FOF(II)+FTERM
        IF(II.EQ.7) FOF(II)=FOF(II)-FTERM
  404   CONTINUE
        IF(DABS(OY).GT.1.D-20.OR.DABS(OZ).GT.1.D-20)THEN
          FOF(4) =FOF(4)-OY*FOF(3)+OZ*FOF(2)
          FOF(5) =FOF(5)-OZ*FOF(1)
          FOF(6) =FOF(6)+OY*FOF(1)
          FOF(10)=FOF(10)-OY*FOF(9)+OZ*FOF(8)
          FOF(11)=FOF(11)-OZ*FOF(7)
          FOF(12)=FOF(12)+OY*FOF(7)
        ENDIF
       ELSE
        DO 405 II=1,12
        R1(II)=0.D0
  405   FOF(II)=0.D0
       ENDIF
C
        IF (ICP.EQ.1)THEN
        q=(PRCV(ICV1)+PRCV(ICV2))/2.
	RRR=DSQRT(ZI*8/POVR)
	RRI=RRR/2-POVR/(RRR*2*PI)
	QPP=Q*PI*RRI**2
        fof(1)=qpp
        fof(7)=-qpp
         ENDIF
        DO 412 II=1,12
          DO 410 JJ=1,12
410       FOF(II)=FOF(II)+SQ(II,JJ)*U(JJ)
         FE(II,NLM)=FOF(II)
412     CONTINUE
        IF(DABS(OY).GT.1.D-20.OR.DABS(OZ).GT.1.D-20)THEN
          FE(4,NLM) =FOF(4)+OY*FOF(3)-OZ*FOF(2)
          FE(5,NLM) =FOF(5)+OZ*FOF(1)
          FE(6,NLM) =FOF(6)-OY*FOF(1)
          FE(10,NLM)=FOF(10)+OY*FOF(9)-OZ*FOF(8)
          FE(11,NLM)=FOF(11)+OZ*FOF(7)
          FE(12,NLM)=FOF(12)-OY*FOF(7)
        ENDIF
C.. TRANSFORMACIJA SILA NA GLOBALNI SISTEM
C       IF(NGENL.GT.0)THEN
        KK=0
        DO 415 L=1,2
         DO 414 II=1,3
         DO 414 JJ=1,3
         R1(II+KK)  =R1(II+KK)  +TRR(JJ,II)*FOF(JJ+KK)
  414    R1(II+KK+6)=R1(II+KK+6)+TRR(JJ,II)*FOF(JJ+KK+6)
         KK=3
  415   CONTINUE
C.. TRANSFORMACIJA MOMENATA IZ GLOBALNOG NA CVORNI LOKALNI SISTEM 
        DO 420 II=1,3
        U(II)=R1(II)
        U(II+6)=R1(II+6)
        U(II+3)=0.D0
  420   U(II+9)=0.D0
      KK=3
      DO 430 L=1,2
       DO 425 II=1,3
       DO 425 JJ=1,3
  425  U(II+KK)=U(II+KK)+TRR2(JJ,II,L)*R1(JJ+KK)
      KK=9
  430 CONTINUE
C...  RASPOREDJIVANJE UNUTRASNJIH SILA U GLOBALNI VEKTOR
        DO 310 II=1,12
        LL=LM(II)
  310   IF(LL.GT.0) FTDT(LL)=FTDT(LL)+U(II)
C       ENDIF
      ENDIF
C
      IF(ISKNP.EQ.0.OR.ISKNP.EQ.1) THEN
C
C    NELINEARAN DEO MATRICE KRUTOSTI
C
      IF(KOR.EQ.1.AND.ITER.LT.2) GO TO 125
      IF(IATYP.EQ.2.OR.IATYP.EQ.3)
     &  CALL SNEL6(SQ,FTT(1,NLM),DUZ,POVR,YI,ZI,TK)
125   CONTINUE
      KK=0
      DO 10 II=1,4
      DO 11 LL=1,3
      DO 11 JJ=1,12
      SKG(LL+KK,JJ)=0.D0
      DO 11 K1=1,3
   11 SKG(LL+KK,JJ)=SKG(LL+KK,JJ)+TRR(K1,LL)*SQ(K1+KK,JJ)
      KK=KK+3
   10 CONTINUE
C.. DEO KOJI ODGOVARA ROTACIJAMA
      DO 15 II=1,3
      DO 15 JJ=1,12
      SQ(II,JJ)=SKG(II,JJ)
      SQ(II+3,JJ)=SKG(II+3,JJ)
      SQ(II+6,JJ)=SKG(II+6,JJ)
      SQ(II+9,JJ)=SKG(II+9,JJ)
      SKG(II+3,JJ)=0.D0
   15 SKG(II+9,JJ)=0.D0
      KK=3
      DO 17 II=1,2
       DO 16 LL=1,3
       DO 16 JJ=1,12
       DO 16 K1=1,3
   16  SKG(LL+KK,JJ)=SKG(LL+KK,JJ)+TRR2(K1,LL,II)*SQ(K1+KK,JJ)
      KK=9
   17 CONTINUE
C
      KK=0
      DO 83 II=1,12
      DO 83 JJ=1,12
      SQ(II,JJ)=SKG(II,JJ)
   83 SKG(II,JJ)=0.D0
      DO 12 II=1,4
      DO 13 LL=1,3
      DO 13 JJ=1,12
      DO 13 K1=1,3
   13 SKG(JJ,LL+KK)=SKG(JJ,LL+KK)+SQ(JJ,K1+KK)*TRR(K1,LL)
      KK=KK+3
   12 CONTINUE
C.. DEO KOJI ODGOVARA ROTACIJAMA
      KK=3
      DO 18 II=1,3
      DO 18 JJ=1,12
      SQ(JJ,II)=SKG(JJ,II)
      SQ(JJ,II+3)=SKG(JJ,II+3)
      SQ(JJ,II+6)=SKG(JJ,II+6)
      SQ(JJ,II+9)=SKG(JJ,II+9)
      SKG(JJ,II+3)=0.D0
   18 SKG(JJ,II+9)=0.D0
      DO 20 II=1,2
       DO 19 LL=1,3
       DO 19 JJ=1,12
       DO 19 K1=1,3
   19  SKG(JJ,LL+KK)=SKG(JJ,LL+KK)+SQ(JJ,K1+KK)*TRR2(K1,LL,II)
      KK=KK+6
   20 CONTINUE
C
CS    FORMIRANJE MATRICE KRUTOSTI U OBLIKU VEKTORA
CE    UPPER SYMETRIC PART IS FORMED
C
      II=0
      DO 101 I=1,12
      DO 101 J=I,12
      II=II+1
  101 SKE(II)=SKG(I,J)
      ENDIF
C
      RETURN
      END
C=======================================================================
      SUBROUTINE TRANG (CTR,NE,ULK,N,IID)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    PODPROGRAM ZA FORMIRANJE MATRICE TRANSF.GREDNOG ELEM.TRR(3,3)
CE    TRANSFORMATION MATRIX       
C
      COMMON /PGREDC/ NPUN,NPRBR,MAXPRR,NPRES,ICV1,ICV2,MATG,
     1                NKARD,MG,NVR,NWRITE,NAPG,INDOF
      COMMON/TRAN/X1,Y1,Z1,X2,Y2,Z2,DUZ,TRR(3,3),AKOR(4)
      COMMON /COMPRF/ YC,ZC,YI,ZI,ALFB,TK,CAPAY,CAPAZ,AREA,POVR,YM,ZM,
     1                DDELT,YP,SWO(1),OM(1),DELTAP(3),TAUTK(3),OY,OZ,
     2                NT,NELM,NTIP,NKAR,IND,INDRPR(3),KR1,NEXTR,NPRPR
      DIMENSION CTR(NE,*),ULK(*)
      DIMENSION T(3,3),TR(3,3),T1(3,3),T2(3,3),PR(4),EF2(3),EF3(3)
      EQUIVALENCE(AKOR(1),PR(1))
C      SQRT(X)=DSQRT(X)
C
      IF(IID.EQ.1)THEN
      DO 1 I=1,3
      DO 1 J=1,3
    1 TRR(I,J)=0.D0
C
      CA=(X2-X1)/DUZ
      CB=(Y2-Y1)/DUZ
      CG=(Z2-Z1)/DUZ
      X12 = CTR(N,1) - X1
      Y12 = CTR(N,2) - Y1
      Z12 = CTR(N,3) - Z1
C
      CS1=CTR(N,1)-X1
      CS2=CTR(N,2)-Y1
      CS3=CTR(N,3)-Z1
      TRR(3,1)=CB*CS3-CG*CS2
      TRR(3,2)=CG*CS1-CA*CS3
      TRR(3,3)=CA*CS2-CB*CS1
      RB=DSQRT(TRR(3,1)*TRR(3,1)+TRR(3,2)*TRR(3,2)+TRR(3,3)*TRR(3,3))
      INGR=0
      IF(RB.LT.1.D-6)THEN
        INGR=1
        WRITE(3,2000) N
        STOP'*** TRANG ***'
      ENDIF
      DO 3 I=1,3
    3 TRR(3,I)=TRR(3,I)/RB      
C
      TRR(1,1)=CA
      TRR(1,2)=CB
      TRR(1,3)=CG
      TRR(2,1)=TRR(3,2)*CG-TRR(3,3)*CB
      TRR(2,2)=TRR(3,3)*CA-TRR(3,1)*CG
      TRR(2,3)=TRR(3,1)*CB-TRR(3,2)*CA
C      CALL WRR(TRR,9,'TRR ')
C
C...   ROTIRANJE U RAVNI PRESEKA ZA UGAO  ALFB
C
      SAL=DSIN(ALFB)
      CAL=DCOS(ALFB)
      DO 4 I=1,3
        EF2(I)= CAL*TRR(2,I)+SAL*TRR(3,I)
    4   EF3(I)=-SAL*TRR(2,I)+CAL*TRR(3,I)
      DO 5 I=1,3
        TRR(2,I)=EF2(I)
    5   TRR(3,I)=EF3(I)
C      CALL WRR(TRR,9,'TRRA')
C
      ELSE
C
      DO 6 I=1,3
      DO 6 J=1,3
      T1(I,J)=0.D0
      T2(I,J)=0.D0
    6 T(I,J)=TRR(I,J)
C
C     FORMIRANJE MATRICE T1
C
      UJI1=ULK(7)-ULK(1)
      UJI2=ULK(8)-ULK(2)
      UJI3=ULK(9)-ULK(3)
      DUJI1=DUZ+UJI1
      DUJI1=DSQRT(DUJI1*DUJI1+UJI3*UJI3)
      DUT=DSQRT(DUJI1*DUJI1+UJI2*UJI2)
      CAT=(DUZ+UJI1)/DUJI1
      SAT=DSQRT(DABS(1.0D0-CAT*CAT))
      SBT=UJI2/DUT
      CBT=DSQRT(DABS(1.0D0-SBT*SBT))
C  KOREKCIJA DUZINE
      DUZ=DUT
C
      T1(1,1)=CAT*CBT
      T1(1,2)=SBT
      T1(1,3)=SAT*CBT
      T1(2,1)=-CAT*SBT
      T1(2,2)=CBT
      T1(2,3)=-SAT*SBT
      T1(3,1)=-SAT
      T1(3,2)=0.0D0
      T1(3,3)=CAT
C....  FORMIRANJE T2
      GAMA=(T1(1,1)*(ULK(4)+ULK(10))+T1(1,2)*(ULK(5)+ULK(11))+
     &      T1(1,3)*(ULK(6)+ULK(12)))/2.0D0
      SAG=DSIN(GAMA)
      CAG=DCOS(GAMA)
      T2(1,1)=1.0D0
      T2(2,2)=CAG
      T2(2,3)=SAG
      T2(3,2)=-SAG
      T2(3,3)=CAG
C....  MATRICA TRANSFORMACIJE  TR =T2*T1
      DO 85 I=1,3
      DO 85 J=1,3
      TR(I,J)=0.D0
      DO 85 K=1,3
  85  TR(I,J)=TR(I,J)+T2(I,K)*T1(K,J)
C....  KONACNA MATRICA TRANSFORMACIJE
      DO 86 I=1,3
      DO 86 J=1,3
      TRR(I,J)=0.D0
      DO 86 K=1,3
  86  TRR(I,J)=TRR(I,J)+TR(I,K)*T(K,J)
      ENDIF
      RETURN
 2000 FORMAT(///2X,'**P A Z NJ A'//
     1'ZA ELEMENT',I3,2X,'NEMOGUCE DEFINISATI MATRICU TRANSFORMACIJE')
      END
C======================================================================
      SUBROUTINE TRANG2(DRV,DRV1,TR,ICV,NP)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    TRANSFORMACIJA ZA LOKALNI SISTEM ROTACIJA
CE    TRANSFORMATION FOR LOKAL ROTATIONS
C
      DIMENSION DRV(NP,*),DRV1(NP,*),TR(3,*),EF1(3),EF2(3),EF3(3) 
C
      IF(DABS(DRV (ICV,3)-1.D0).LT.1.D-10 .AND.
     &   DABS(DRV1(ICV,1)-1.D0).LT.1.D-10)THEN
      DO 6 I=1,3
      DO 5 J=1,3
    5 TR(I,J)=0.D0
    6 TR(I,I)=1.D0
      RETURN
      ENDIF
C..  U SLUCAJU DA SE NE POKLAPAJU LOKALNI I GLOBALNI SISTEM (CVOR LJUSKE)
      DO 10 I=1,3
      EF1(I)=DRV1(ICV,I)
      EF3(I)=DRV (ICV,I)
      TR(I,1)=EF1(I)
   10 TR(I,3)=EF3(I)
C
      CALL V1V2(EF1,EF2,EF3,2)
      DO 20 I=1,3
   20 TR(I,2)=EF2(I)
      RETURN
      END
C======================================================================
      SUBROUTINE MEL611(FUN)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    FORMIRANJE MATRICE ELAST
CE    MATRIX ELAST IS FORMED
C
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEMEN/ ELAST(6,6),XJ(3,3),ALFA(6),TEMP0,DET,NLM,KK
      COMMON /PGREDG/ ELCON(3),EE,PNE,G
      DIMENSION FUN(2,*)
C
      EE=FUN(1,MAT)
      PNE=FUN(2,MAT)
C      WRITE(3,*) 'NLM,MAT,E,V',NLM,MAT,EE,PNE
      RETURN
      END
C======================================================================
      SUBROUTINE MEL631(FUN,NTA,TEM,MATE,TGT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C     FORMIRANJE MATRICE ELAST
C
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEMEN/ ELAST(6,6),XJ(3,3),ALFA(6),TEMP0,DET,NLM,KK
      COMMON /PGREDG/ ELCON(3),EE,PNE,G
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      DIMENSION FUN(2,MATE*3,*),NTA(*),TEM(*)
C
C     UCITAVANJE FUNKCIJE E,V,ALFA
C
      DO 6 J=1,3
      NFE=(MAT-1)*3+J
      CALL TABF(FUN,NTA,NFE,MATE*3,TGT,EVA,NTMX,IND)
      IF(IND.GT.0) GO TO 120
      IF(J.EQ.1) EE=EVA
      IF(J.EQ.2) PNE=EVA
    6 CONTINUE
      ALFA(1)=EVA
      TEMP0=TEM(MAT)
      RETURN
  120 WRITE(IZLAZ,2000) NFE,TGT
 2000 FORMAT(///' ARGUMENT VAN OPSEGA ZADATE KRIVE U MEL631'/
     1' TEMPERATURSKA FUNKCIJA BROJ =',I5/
     2' ARGUMENT TEMPERATURA =',D12.4)
      STOP
      END
C======================================================================
      SUBROUTINE SEL6(S,DUZ,POVR,YI,ZI,TK,EE,G,CAPAY,CAPAZ,OY,OZ)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    LINEARNA MATRICA KRUTOSTI
CE    LINEAR STIFFNES MATRIX
C
      DIMENSION S(12,*)
      DO 70 I=1,12
      DO 70 J=I,12
   70 S(J,I)=0.D0
      DUZ2 = DUZ*DUZ
      DUZ3 = DUZ2*DUZ
C      FIY=12.D0*CAPAZ*EE*ZI/(G*POVR*DUZ2)
C      FIZ=12.D0*CAPAY*EE*YI/(G*POVR*DUZ2)
C      FIZ1 = 1.D0+ FIZ
C      FIY1 = 1.D0+ FIY
      EBDUZ=EE/DUZ
      S(1,1) = EBDUZ*POVR
      S(1,5) =-S(1,1)*OZ
      S(1,6) = S(1,1)*OY
      S(1,7) =-S(1,1)
      S(1,11)=-S(1,5)
      S(1,12)=-S(1,6)
      S(2,2) = 12.D0*ZI*EE/DUZ3
      S(2,4) = S(2,2)*OZ
      S(2,6) = 6.D0*ZI*EE/DUZ2
      S(2,8) =-S(2,2)
      S(2,10)=-S(2,4)
      S(2,12)= S(2,6)
      S(3,3) = 12.D0*YI*EE/DUZ3
      S(3,4) =-S(3,3)*OY
      S(3,5) =-6.D0*YI*EE/DUZ2
      S(3,9) =-S(3,3)
      S(3,10)=-S(3,4)
      S(3,11)= S(3,5)
      S(4,4) = G*TK/DUZ + S(2,4)*OZ - S(3,4)*OY
      S(4,5) =-S(3,5)*OY
      S(4,6) = S(2,6)*OZ
      S(4,8) =-S(2,4)
      S(4,9) =-S(3,4)
      S(4,10)=-S(4,4)
      S(4,11)= S(4,5)
      S(4,12)= S(4,6)
      S(5,5) = 4.D0*YI*EE/DUZ - S(1,5)*OZ 
      S(5,6) = S(1,5)*OY
      S(5,7) =-S(1,5)
      S(5,9) =-S(3,5)
      S(5,10)=-S(4,5)
      S(5,11)= 2.D0*YI*EE/DUZ + S(1,5)*OZ
      S(5,12)=-S(5,6)
      S(6,6) = 4.D0*ZI*EE/DUZ + S(1,6)*OY
      S(6,7) =-S(1,6)
      S(6,8) =-S(2,6)
      S(6,10)=-S(4,6)
      S(6,11)=-S(5,6)
      S(6,12)= 2.D0*ZI*EE/DUZ - S(1,6)*OY
C
      S(7,7) = S(1,1)
      S(7,11)= S(1,5)
      S(7,12)= S(1,6)
      S(8,8) = S(2,2)
      S(8,10)= S(2,4)
      S(8,12)=-S(2,6)
      S(9,9) = S(3,3)
      S(9,10)= S(3,4)
      S(9,11)=-S(3,5)
      S(10,10)=S(4,4)
      S(10,11)=-S(4,5)
      S(10,12)=-S(4,6)
      S(11,11)=S(5,5)
      S(11,12)=S(5,6)
      S(12,12)=S(6,6)
      DO 71 I=1,12
      DO 71 J=I,12
   71 S(J,I)=S(I,J)
      RETURN
      END
      SUBROUTINE ELTE6L(ID,CORD,NEL,NTIPG,CTR,MGLV,LUV,GUSM,
     1 SQ,SKG,SKE,LM,FE,FTDT,RTDT,UTT,FTT,UT1,FT1,ZAPS,NPRZ,
     2 INDZS,NCVE6,GRZAP,GRMAS,TG1,TECV,PRCV)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    OVAJ PODPROGRAM SLUZI ZA FORMIRANJE MATRICE KRUTOSTI 12X12
CS    LINIJSKOG ELEMENTA TANKOZIDNE GREDE
CE    ELEMENT STIFFNES MATRIX CALCULATION 
C
      include 'paka.inc'
      
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /GRUPEE/ NGEL,NGENL,LGEOM,NGEOM,ITERM
      COMMON /ITERAC/ METOD,MAXIT,TOLE,TOLS,TOLM,KONVE,KONVS,KONVM
      COMMON /PERKOR/ LNKDT,LDTDT,LVDT,NDT,DT,VREME,KOR
      COMMON /REPERM/ MREPER(4)
      COMMON /TEMPCV/ LTECV,ITEMP
      COMMON /ELEMEN/ ELAST(6,6),XJ(3,3),ALFA(6),TEMP0,DET,NLM,KK
      COMMON /PLASTI/ LPLAST,LPLAS1,LSIGMA
      COMMON /ANALIZ/ LINEAR,ITERGL,INDDIN
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /DIREKT/ LSTAZZ(9),LDRV0,LDRV1,LDRV,IDIREK
      COMMON /ITERBR/ ITER
      COMMON /PAKDFL/ IND16,IR16,IND40,IND49,IND69,IND99
      COMMON /PGREDG/ ELCON(3),EE,PNE,G
      COMMON /PGREDC/ NPUN,NPRBR,MAXPRR,NPRES,ICV1,ICV2,MATG,
     1                NKARD,MG,NVR,NWRITE,NAPG,INDOF
      COMMON /COMPRF/ YC,ZC,YI,ZI,ALFB,TK,CAPAY,CAPAZ,AREA,POVR,YM,ZM,
     1                DDELT,YP,SWO(1),OM(1),DELTAP(3),TAUTK(3),OY,OZ,
     2                NT,NELM,NTIP,NKAR,IND,INDRPR(3),KR1,NEXTR,NPRPR
      COMMON/TRAN/X1,Y1,Z1,X2,Y2,Z2,DUZ,TRR(3,3),AKOR(4)
       COMMON/LUK/RO10,BES,RO1,RO2,RO3,RO4,RO6,RO7,RO9,RO,ROO,TT(3,3)
      COMMON /LUCGRE/ ILU,ICP
      DIMENSION ID(NP,*),CORD(NP,*),NEL(NE,*),NTIPG(NE,*),GUSM(50,*),
     1CTR(NE,*),MGLV(*),LUV(NE,*),ZAPS(*),NPRZ(*),TG1(*)
C
      DIMENSION SQ(NCVE6,*),SKG(NCVE6,*),LM(*),SKE(*), FE(12,*),
     1 FTDT(*),RTDT(*),UTT(12,*),FTT(12,*),UT1(12,*),FT1(12,*),
     2 U(12),R1(12),TRR2(3,3,2),FOF(12),UTHERM(12),TECV(*),PRCV(*)
C
C      SQRT(X)=DSQRT(X)
      NSZM = 0
      NVERT = 0
      NPUN = 0
      PI = 1.
      PI = 4.*DATAN(PI)
        MAT = NTIPG(NLM,2)
      GO TO (1,991,3,991,991,991,991,991),NMODM
    1 LFUN=MREPER(1)
      CALL MEL611(A(LFUN))
       GO TO 991
    3       LFUN=MREPER(1)
            LNTA=MREPER(2)
            LTEM=MREPER(3)
            MATE=MREPER(4)
         CALL MEL631(A(LFUN),A(LNTA),A(LTEM),MATE,A(LTECV))
  991 CONTINUE
C
CS    ODREDITI BROJEVE CVOROVA I KARAKTERISTIKE ELEMENTA
CE    NODE NUMBERS
      ICV1=NEL(NLM,1)
      ICV2=NEL(NLM,2)
C
      DO 100 I=1,6
      LM(I)=ID(ICV1,I)
  100 LM(I+6)=ID(ICV2,I)
C
      DO 498 I=1,12
 498  UTHERM(I)=0.
      X1=CORD(ICV1,1)
      Y1=CORD(ICV1,2)
      Z1=CORD(ICV1,3)
      X2=CORD(ICV2,1)
      Y2=CORD(ICV2,2)
      Z2=CORD(ICV2,3)
       X3=CTR(NE,1)
       Y3=CTR(NE,2)
       Z3=CTR(NE,3)
       RO10=DSQRT((X1-X3)**2+(Y1-Y3)**2+(Z1-Z3)**2)
       RO=RO10**2/ZI
       ROO=RO10/ZI
       RO1=RO10**2/ZI
       RO2=2*RO10**2*(1+PNE)/(ZI+YI)
       RO3=RO10/YI
       RO4=2*RO10*(1+PNE)/(ZI+YI)
       RO6=1./ZI
       RO7=2*(1+PNE)/(ZI+YI)
       RO9=1./ZI
       BES=((X3-X1)*(X3-X2)+(Y3-Y1)*(Y3-Y2)+(Z3-Z1)*(Z3-Z2))/RO10**2
       BES=DACOS(BES)
       GG=1.
	VV=DATAN(GG)*4
       DUZ=BES*RO10
C
C
      G=EE/(2.D0*(1.D0+PNE))
      GUST=GUSM(NMODM,MAT)
      ZAPRE=DUZ*POVR
      AMASA=GUST*ZAPRE
      AMAS2=AMASA*.5
         IF(ITER.EQ.0.AND.INDZS.GT.0) THEN
            GRZAP=GRZAP+ZAPRE
            GRMAS=GRMAS+AMASA
         ENDIF
C        RASPOREDJIVANJE KONCENTRISANIH MASA U VEKTOR ZAPS
         IF(ITER.EQ.0.AND.INDZS.GT.0)THEN
            DO 500 I=1,2
            I6=(I-1)*6
            DO 500 K=1,3
               NJ=LM(I6+K)
               IF(NJ.GT.0) THEN
                  NPRNJ=NPRZ(NJ)
                  IF(NPRNJ.GT.0.AND.NPRNJ.NE.K) STOP 'NPRNJ'
                  NPRZ(NJ)=K
                  ZAPS(NJ)=ZAPS(NJ)+AMAS2
               ENDIF
  500       CONTINUE
         ENDIF
C
CS    ODREDIVANJE MATRICE TRANSFORMACIJE TR
CE    TRANSFORMATION MATRIX
C
      CALL TRANGL (CTR,NE,U,NLM,1)
C.. TRANSFORMACIJE ZA LOKALNE ROTACIJE
      CALL CLEAR(TRR2,18)
      CALL TRANG2(A(LDRV),A(LDRV1),TRR2(1,1,1),ICV1,NP)
      CALL TRANG2(A(LDRV),A(LDRV1),TRR2(1,1,2),ICV2,NP)
C
CS     POMERANJA U LOKALNOM SISTEMU
CE     LOCAL DISPLACEMENTS
C
      IF(NMODM.EQ.3.AND.ISKNP.EQ.2.AND.ITERME.NE.0)THEN
      CALL UTERML (UTHERM,A(LTEM),MATE,A(LTECV))
       ENDIF
      DO 301 I=1,12
      R1(I)=0.D0
      IBR=LM(I)
      RTDT(IBR)=RTDT(IBR)+UTHERM(I)
  301 IF(IBR.GT.0) R1(I)=RTDT(IBR)
      DO 371 II=1,3
      U(II)=R1(II)
      U(II+6)=R1(II+6)
      U(II+3)=0.D0
  371    U(II+9)=0.D0
C.. TRANSFORMACIJA ROTACIJA IZ CVORNOG LOKALNOG SISTEMA NA GLOBALNI
      KK=3
      DO 503 L=1,2
       DO 502 II=1,3
       DO 502 JJ=1,3
  502  U(II+KK)=U(II+KK)+TRR2(II,JJ,L)*R1(JJ+KK)
      KK=9
  503 CONTINUE
      DO 506 II=1,12
  506 R1(II)=U(II)
C.. TRANSFORMACIJA NA GREDNI LOKALNI SISTEM U TRENUTKU "0"
      KK=0
      DO 383 L=1,2
      DO 384 II=1,3
      U(II+KK)=0.D0
      U(II+KK+6)=0.D0
      DO 384 JJ=1,3
      U(II+KK)=U(II+KK)+TRR(II,JJ)*R1(JJ+KK)
  384 U(II+KK+6)=U(II+KK+6)+TT(II,JJ)*R1(JJ+KK+6)
      KK=3
  383 CONTINUE
CC
C....  DOPUNSKA TRANSFORMACIJA ZBOG GEOMETRIJSKE NELINEARNOSTI
C
      IF(IATYP.EQ.2.OR.IATYP.EQ.3)THEN
        CALL TRANGL (CTR,NE,U,NLM,2)
C
C....  PRIRASTAJI POMERANJA
C
      DO 385 II=1,12
        UT1(II,NLM)=R1(II)
  385   R1(II)=R1(II)-UTT(II,NLM)
C..    TRANSFORMACIJA PRIRASTAJA POMERANJA NA 
C      GREDNI LOKALNI SISTEM U TRENUTKU "T+DT"
        KK=0
        DO 387 L=1,2
         DO 386 II=1,3
          U(II+KK)=0.D0
          U(II+KK+6)=0.D0
          DO 386 JJ=1,3
           U(II+KK)=U(II+KK)+TRR(II,JJ)*R1(JJ+KK)
  386      U(II+KK+6)=U(II+KK+6)+TRR(II,JJ)*R1(JJ+KK+6)
         KK=3
  387   CONTINUE
      ENDIF
C
CS    LINEARNA MATRICA KRUTOSTI
CE    LINEAR STIFFNES MATRIX
C
      CALL SEL6L(SQ,DUZ,POVR,YI,ZI,TK,EE,G,CAPAY,CAPAZ,OY,OZ)
C   
C  KOREKCIJA MATRICE SQ AKO IMA SLOBODNIH POMERANJA
      IF(MG.EQ.0) GO TO 110
      IF(MG.EQ.2) GO TO 111
C  VEZE ZGLOBNE U SVIM CVOROVIMA
      NBRS=0
      DO 112 IJ=1,2
      DO 113 I=4,6
      DO 113 J=1,12
  113 SQ(I+NBRS,J)=0.D0
      DO 114 J=4,6
      DO 114 I=1,12
  114 SQ(I,J+NBRS)=0.D0
      NBRS=6
  112 CONTINUE
      GO TO 110
C  SLOBODNA NEKA POMERANJA U LOKALNOM SISTEMU
  111 IF(MGLV(NLM).EQ.0) GO TO 110
      DO 115 I=1,12
      IF(LUV(NLM,I).EQ.0) GO TO 115
      DO 116 J=1,12
  116 SQ(I,J)=0.D0
      DO 117 J=1,12
  117 SQ(J,I)=0.D0
  115 CONTINUE
  110 CONTINUE
C
CS     RACUNANJE UNUTRASNJIH SILA U LOKALNOM SISTEMU
CE     INTERNAL FORCES CALCULATIN
C
        if(iaTYP.NE.0)THEN
        DO 404 II=1,12
        R1(II)=0.D0
        FOF(II)=FTT(II,NLM)
  404   CONTINUE
        IF(DABS(OY).GT.1.D-20.OR.DABS(OZ).GT.1.D-20)THEN
          FOF(4) =FOF(4)-OY*FOF(3)+OZ*FOF(2)
          FOF(5) =FOF(5)-OZ*FOF(1)
          FOF(6) =FOF(6)+OY*FOF(1)
          FOF(10)=FOF(10)-OY*FOF(9)+OZ*FOF(8)
          FOF(11)=FOF(11)-OZ*FOF(7)
          FOF(12)=FOF(12)+OY*FOF(7)
        ENDIF
       ELSE
        DO 405 II=1,12
        R1(II)=0.D0
  405   FOF(II)=0.D0
       ENDIF
         if(icp.eq.1)then
	 sG1=Dsin(BES/2)
	 sG2=Dsin(3*BES/2)
	 sG3=Dsin(5*BES/2)
	 CG1=DCOS(BES/2)
	 CG2=DCOS(3*BES/2)
	 CG3=DCOS(5*BES/2)
	FIP=4.*BES*CG1-4.*BES*CG2/3.-8.*SG1+8.*SG2/9.
	FI2=2.*BES*CG1-4.*BES*CG2/3-4.*SG1+8.*SG2/9.+2.*BES*CG3/5.-
     1	4.*SG3/25.
	FI3=-BES*SG1-2.*CG1+2.16-2.*BES*SG3/5.-4.*CG3/25.
        q=(PRCV(ICV1)+PRCV(ICV2))/2.
	RRR=DSQRT(ZI*8/POVR)
	RRI=RRR/2-POVR/(RRR*2*PI)
	QPP=Q*PI*RRI**2
	fOF(1)=-QPP*bes*dcos(bes/2)/2.
	fOF(2)=-QPP*bes*dsin(bes/2)/2.+QPP
	fOF(7)=-QPP*bes*dcos(bes/2)/2.+QPP
	fOF(8)=-QPP*bes*dsin(bes/2)/2.
	fOF(6)=RO10*QPP*(FI2+FI3-2.*FIP)/(2.*(1-DCOS(BES)))
	fOF(12)=-fOF(6)
	 ENDIF
        DO 412 II=1,12
          DO 410 JJ=1,12
410       FOF(II)=FOF(II)+SQ(II,JJ)*U(JJ)
         FE(II,NLM)=FOF(II)
412     CONTINUE
        IF(DABS(OY).GT.1.D-20.OR.DABS(OZ).GT.1.D-20)THEN
          FE(4,NLM) =FOF(4)+OY*FOF(3)-OZ*FOF(2)
          FE(5,NLM) =FOF(5)+OZ*FOF(1)
          FE(6,NLM) =FOF(6)-OY*FOF(1)
          FE(10,NLM)=FOF(10)+OY*FOF(9)-OZ*FOF(8)
          FE(11,NLM)=FOF(11)+OZ*FOF(7)
          FE(12,NLM)=FOF(12)-OY*FOF(7)
        ENDIF
C.. TRANSFORMACIJA SILA NA GLOBALNI SISTEM
C       IF(NGENL.GT.0)THEN
        KK=0
        DO 415 L=1,2
         DO 414 II=1,3
         DO 414 JJ=1,3
         R1(II+KK)  =R1(II+KK)  +TRR(JJ,II)*FOF(JJ+KK)
  414    R1(II+KK+6)=R1(II+KK+6)+TRR(JJ,II)*FOF(JJ+KK+6)
         KK=3
  415   CONTINUE
C.. TRANSFORMACIJA MOMENATA IZ GLOBALNOG NA CVORNI LOKALNI SISTEM 
        DO 420 II=1,3
        U(II)=R1(II)
        U(II+6)=R1(II+6)
        U(II+3)=0.D0
  420   U(II+9)=0.D0
        KK=3
        DO 430 L=1,2
        DO 425 II=1,3
        DO 425 JJ=1,3
  425  U(II+KK)=U(II+KK)+TRR2(JJ,II,L)*R1(JJ+KK)
      KK=9
  430 CONTINUE
C...  RASPOREDJIVANJE UNUTRASNJIH SILA U GLOBALNI VEKTOR
        DO 310 II=1,12
        LL=LM(II)
  310   IF(LL.GT.0) FTDT(LL)=FTDT(LL)+U(II)
C       ENDIF
C      ENDIF
C
C      IF(ISKNP.EQ.0.OR.ISKNP.EQ.1) THEN
C
C    NELINEARAN DEO MATRICE KRUTOSTI
C
      IF(KOR.EQ.1.AND.ITER.LT.2) GO TO 125
      IF(IATYP.EQ.2.OR.IATYP.EQ.3)
     &  CALL SNEL6(SQ,FTT(1,NLM),DUZ,POVR,YI,ZI,TK)
 125   CONTINUE
      KK=0
      DO 10 II=1,2
      DO 11 LL=1,3
      DO 11 JJ=1,12
      SKG(LL+KK,JJ)=0.D0
      DO 11 K1=1,3
   11 SKG(LL+KK,JJ)=SKG(LL+KK,JJ)+TRR(K1,LL)*SQ(K1+KK,JJ)
      KK=KK+3
   10 CONTINUE
C.. DEO KOJI ODGOVARA ROTACIJAMA
      KK=6
      DO 666 II=3,4
      DO 667 LL=1,3
      DO 667 JJ=1,12
      SKG(LL+KK,JJ)=0.D0
      DO 667 K1=1,3
 667  SKG(LL+KK,JJ)=SKG(LL+KK,JJ)+TT(K1,LL)*SQ(K1+KK,JJ)
      KK=KK+3
 666  CONTINUE
C.. DEO KOJI ODGOVARA ROTACIJAMA
CC
      KK=0
      DO 83 II=1,12
      DO 83 JJ=1,12
      SQ(II,JJ)=SKG(II,JJ)
   83 SKG(II,JJ)=0.D0
      DO 12 II=1,2
      DO 13 LL=1,3
      DO 13 JJ=1,12
      DO 13 K1=1,3
   13   SKG(JJ,LL+KK)=SKG(JJ,LL+KK)+SQ(JJ,K1+KK)*TRR(K1,LL)
      KK=KK+3
   12 CONTINUE
      KK=6
      DO 128 II=3,4
      DO 138 LL=1,3
      DO 138 JJ=1,12
      DO 138 K1=1,3
  138    SKG(JJ,LL+KK)=SKG(JJ,LL+KK)+SQ(JJ,K1+KK)*TT(K1,LL)
      KK=KK+3
 128  CONTINUE
C.. DEO KOJI ODGOVARA ROTACIJAMA
C
CS    FORMIRANJE MATRICE KRUTOSTI U OBLIKU VEKTORA
CE    UPPER SYMETRIC PART IS FORMED
C
      II=0
      DO 101 I=1,12
      DO 101 J=I,12
      II=II+1
 101      SKE(II)=SKG(I,J)
C      ENDIF
C
C      CALL TGRAFL(CORD,NCVEL,ICVEL,NPP,NLM,CTR,NE,U)
      RETURN
      END
C=======================================================================
      SUBROUTINE TRANGL (CTR,NE,ULK,N,IID)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS    PODPROGRAM ZA FORMIRANJE MATRICE TRANSF.GREDNOG ELEM.TRR(3,3)
CE    TRANSFORMATION MATRIX       
C
      COMMON /PGREDC/ NPUN,NPRBR,MAXPRR,NPRES,ICV1,ICV2,MATG,
     1                NKARD,MG,NVR,NWRITE,NAPG,INDOF
      COMMON/TRAN/X1,Y1,Z1,X2,Y2,Z2,DUZ,TRR(3,3),AKOR(4)
      COMMON /COMPRF/ YC,ZC,YI,ZI,ALFB,TK,CAPAY,CAPAZ,AREA,POVR,YM,ZM,
     1                DDELT,YP,SWO(1),OM(1),DELTAP(3),TAUTK(3),OY,OZ,
     2                NT,NELM,NTIP,NKAR,IND,INDRPR(3),KR1,NEXTR,NPRPR
       COMMON/LUK/RO10,BES,RO1,RO2,RO3,RO4,RO6,RO7,RO9,RO,ROO,TT(3,3)
      DIMENSION CTR(NE,*),ULK(*)
      DIMENSION PR(4)
      EQUIVALENCE(AKOR(1),PR(1))
C      SQRT(X)=DSQRT(X)
C
      DO 1 I=1,3
      DO 1 J=1,3
      TT(I,J)=0.D0
    1 TRR(I,J)=0.D0
C
C-------------------------------------------------------------------
C MATRICA TRANSFORMACIJE NA GLOBALNI K.SISTEM
C---------------------------------------------------------------------- 
       X3=CTR(NE,1)
       Y3=CTR(NE,2)
       Z3=CTR(NE,3)
      UK1=DSQRT((X1-X3)**2+(Y1-Y3)**2+(Z1-Z3)**2)
      TN11=(X1-X3)/UK1
      TN12=(Y1-Y3)/UK1
      TN13=(Z1-Z3)/UK1
      X31=(Y1-Y3)*(Z2-Z3)-(Z1-Z3)*(Y2-Y3)
      Y31=(Z1-Z3)*(X2-X3)-(X1-X3)*(Z2-Z3)
      Z31=(X1-X3)*(Y2-Y3)-(Y1-Y3)*(X2-X3)
      UK3=DSQRT(X31**2+Y31**2+Z31**2)
      TN31=X31/UK3
      TN32=Y31/UK3
      TN33=Z31/UK3
      TRR(2,1)=TN32*TN13-TN33*TN12
      TRR(2,2)=TN33*TN11-TN31*TN13
      TRR(2,3)=TN31*TN12-TN32*TN11
C
      TRR(1,1)=TN11
      TRR(1,2)=TN12
      TRR(1,3)=TN13
      TRR(3,1)=TN31
      TRR(3,2)=TN32
      TRR(3,3)=TN33
C---------------------------------------------------------------
      UK2=DSQRT((X2-X3)**2+(Y2-Y3)**2+(Z2-Z3)**2)
      T11=(X2-X3)/UK2
      T12=(Y2-Y3)/UK2
      T13=(Z2-Z3)/UK2
      TT(2,1)=TN32*T13-TN33*T12
      TT(2,2)=TN33*T11-TN31*T13
      TT(2,3)=TN31*T12-TN32*T11
      TT(1,1)=T11
      TT(1,2)=T12
      TT(1,3)=T13
      TT(3,1)=TN31
      TT(3,2)=TN32
      TT(3,3)=TN33
      RETURN
      END
C======================================================================
      SUBROUTINE SEL6L(S,DUZ,POVR,YI,ZI,TK,EE,G,CAPAY,CAPAZ,OY,OZ)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
       COMMON/LUK/RO10,BES,RO1,RO2,RO3,RO4,RO6,RO7,RO9,RO,ROO,TT(3,3)
CC
CS    LINEARNA MATRICA KRUTOSTI
CE    LINEAR STIFFNES MATRIX
C
      DIMENSION S(12,12),D(6,6),DF(36),SR(36),P(36),Y(36),T(36),Q(36)
      DIMENSION L(12),M(12)
      CC=1.
       GG=1.
	VV=DATAN(GG)*4
      DO 70 I=1,12
      DO 70 J=I,12
   70 S(J,I)=0.D0
      DO 711 I=1,6
      DO 711 J=I,6
  711  D(I,J)=0.D0
      DO 721 I=1,36
       DF(I)=0.
       SR(I)=0.
       P(I)=0.
       Y(I)=0.
       T(I)=0.
  721    Q(I)=0.
C MATRICA RAVNOTEZE SPOLJASNIH I UNUTRASNJIH SILA SLOZENA PO VRSTAMA
C-------------------------------------------------------------------
       SR(1)=-DCOS(BES)
       SR(7)=-DSIN(BES)
       SR(2)=DSIN(BES)
       SR(8)=-DCOS(BES)
       SR(15)=-1.
       SR(16)=RO10*DSIN(BES)
       SR(22)=-DCOS(BES)
       SR(28)=-DSIN(BES)
       SR(17)=-RO10*(1-DCOS(BES))
       SR(23)=DSIN(BES)
       SR(29)=-DCOS(BES)
       SR(6)=-RO10*DSIN(BES)
       SR(12)=-RO10*(1-DCOS(BES))
       SR(36)=-1.
      CALL MTRA(SR,T,6,6)
C------------------------------------------------------------------------
C MATRICA FLEKSIBILNOSTI
C------------------------------------------------------------------------
       D(1,1)=RO*(BES/2-DSIN(2*BES)/4)
       D(1,2)=RO*(1-DCOS(BES)-(DSIN(BES))**2/2)
       D(1,6)=ROO*(1-DCOS(BES))
       D(2,2)=RO*(3*BES/2+DSIN(2*BES)/4-2*DSIN(BES))
       D(2,6)=ROO*(BES-DSIN(BES))
       D(3,3)=RO1*(BES/2-DSIN(2*BES)/4)+RO2*(3*BES/2+DSIN(2*BES)/4
     1  -2*DSIN(BES))
       D(3,4)=-RO3*((DSIN(BES))**2/2)-RO4*(1-DCOS(BES)-(DSIN(BES))**2
     1  /2)
       D(3,5)=-RO3*(BES/2-DSIN(2*BES)/4)+RO4*(-BES/2-DSIN(2*BES)/4
     1  +DSIN(BES))
       D(4,4)=RO6*(BES/2+DSIN(2*BES)/4)+RO7*(BES/2-DSIN(2*BES)/4)
       D(4,5)=RO6*((DSIN(BES))**2/2)-RO7*((DSIN(BES))**2/2)
       D(5,5)=RO6*(BES/2-DSIN(2*BES)/4)+RO7*(BES/2+DSIN(2*BES)/4)
       D(6,6)=BES*RO9
       DO 144 I=1,6
       DO 144 J=I,6
 144   D(J,I)=D(I,J)
C---------------------------------------------------------
C MATRICA FLEKSIBILNOSTI SLOZENA PO VRSTAMA
C---------------------------------------------------------
      II=0
      DO 146 I=1,6
      DO 146 J=1,6
      II=II+1
 146      DF(II)=D(I,J)*RO10/EE
C-----------------------------------------------------------------
C---------------------------------------------------------------
C MATRICA KRUTOSTI U LOKALNOM KOORDINATNOM SISTEMU
C-----------------------------------------------------------------
C blok matrica [K11] 6X6 DF
C-----------------------------------------------------------------
       CALL MINV(DF,6,CC,L,M)
C----------------------------------------------------------------
      S(1,1)=DF(1)
      S(1,2)=DF(2)
      S(1,6)=DF(6)
      S(2,2)=DF(8)
      S(2,6)=DF(12)
      S(3,3)=DF(15)
      S(3,4)=DF(16)
      S(3,5)=DF(17)
      S(4,4)=DF(22)
      S(4,5)=DF(23)
      S(5,5)=DF(29)
      S(6,6)=DF(36)
C----------------------------------------------------------------
C blok matrica [K21] 6X6 PT
C-----------------------------------------------------------------
      CALL GMPRD(SR,DF,P,6,6,6) 
C----------------------------------------------------------------
      S(1,7)=P(1)
      S(2,7)=P(7)
      S(6,7)=P(31)
      S(1,8)=P(2)
      S(2,8)=P(8)
      S(6,8)=P(32)
      S(3,9)=P(15)
      S(4,9)=P(21)
      S(5,9)=P(27)
      S(3,10)=P(16)
      S(4,10)=P(22)
      S(5,10)=P(28)
      S(3,11)=P(17)
      S(4,11)=P(23)
      S(5,11)=P(29)
      S(1,12)=P(6)
      S(2,12)=P(12)
      S(6,12)=P(36)
C----------------------------------------------------------------
C blok matrica [K22] 6X6 Y
C-----------------------------------------------------------------
      CALL GMPRD(DF,T,Q,6,6,6)
      CALL GMPRD(SR,Q,Y,6,6,6)
C-----------------------------------------------------------------
      S(7,7)=Y(1)
      S(7,8)=Y(2)
      S(7,12)=Y(6)
      S(8,8)=Y(8)
      S(8,12)=Y(12)
      S(9,9)=Y(15)
      S(9,10)=Y(16)
      S(9,11)=Y(17)
      S(10,10)=Y(22)
      S(10,11)=Y(23)
      S(11,11)=Y(29)
      S(12,12)=Y(36)
      DO 71 I=1,12
      DO 71 J=1,12
   71 S(J,I)=S(I,J)
      RETURN
      END
C=======================================================================
      SUBROUTINE UTERML(UTHERM,TEM,MATE,TTEM)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C ......................................................................
C .
CS.   P R O G R A M
CS.      ZA IZRACUNAVANJE TERMICKIH POMERANJA
C .
C ......................................................................
C
      COMMON /ELEMEN/ ELAST(6,6),XJ(3,3),ALFA(6),TEMP0,DET,NLM,KK
      COMMON /COMPRF/ YC,ZC,YI,ZI,ALFB,TK,CAPAY,CAPAZ,AREA,POVR,YM,ZM,
     1                DDELT,YP,SWO(1),OM(1),DELTAP(3),TAUTK(3),OY,OZ,
     2                NT,NELM,NTIP,NKAR,IND,INDRPR(3),KR1,NEXTR,NPRPR
      COMMON/TRAN/X1,Y1,Z1,X2,Y2,Z2,DUZ,TRR(3,3),AKOR(4)
       COMMON/LUK/RO10,BES,RO1,RO2,RO3,RO4,RO6,RO7,RO9,RO,ROO,TT(3,3)
      DIMENSION UTHERM(12),TTEM(3)
C
      DTGT0=TTEM(1)-TEMP0
       UTHERM(1)=RO10*ALFA(1)*DTGT0*DSIN(BES)
      UTHERM(2)=RO10*ALFA(1)*DTGT0*(DSIN(BES)**2)
       UTHERM(7)=2*RO10*ALFA(1)*DTGT0*DSIN(BES)
      UTHERM(8)=UTHERM(2)
      RETURN
      END
