C=======================================================================
C
C   SUBROUTINE UL93GL
C              UL93EK
C              LMMH93
C              TGRF93
C
C=======================================================================
      SUBROUTINE UL93GL
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      CHARACTER*250 ACOZ
C
CS     GLAVNI UPRAVLJACKI PROGRAM ZA ULAZNE PODATAKE 3/D KONTAKTA
CE     MAIN PROGRAM FOR INPUT DATA ABOUT 3/D CONTACT ELEMENTS
C
      include 'paka.inc'
      
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      COMMON /ELEMAU/ MXAU,LAU,LLMEL,LNEL,LNMAT,LTHID,LIPGC,LIPRC,LISNA,
     1 LMXAU,LAPRS
      COMMON /ORIENT/ CPP(3,3),XJJ(3,3),TSG(6,6),BETA,LBET0,IBB0
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /DUZINA/ LMAX,MTOT,LMAXM,LRAD,NRAD
      COMMON /DUPLAP/ IDVA
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /SRPSKI/ ISRPS
      COMMON /RSN   / DETER,IPIVOT,IDETER
      COMMON /KONTKT/ ICONT,NEQC,NEQ,NWKC,LMAXAC,LRCTDT
      COMMON /KONTK3/ FMSTAT,FMDIN,EPSIL,NTSF,NTTOT,LNCVSF,LITSRF,
     &                LNELSF,LIDC,LIK,LIK1,LFSFD,LMASE,LNELAB,NWKCDY
      COMMON /KONTK0/ IRESCT
      COMMON /PENALTY/ AKN,AKS,IPENALTY
C
C... PRIVREMENO RESENJE ZA NEGATIVAN PIVOT, POSLE UBACITI U RESEN
C    PROVERU ZA ICONT=1 I BROJ JEDNACINE VECI OD NEQ
CC      IPIVOT=1
      ICONT=1
      IRESCT=0
      NWKCDY=0
C
CE    BASIC DATA ABOUT ELEMENTS
CS    OSNOVNI PODACI O ELEMENTIMA
C
      CALL ISPITA(ACOZ)
      IF(INDFOR.EQ.1)
     1READ(IULAZ,*)   NTSF,FMSTAT,FMDIN,EPSIL,IPENALTY,AKN,AKS
      IF(INDFOR.EQ.2)
     1READ(ACOZ,1010) NTSF,FMSTAT,FMDIN,EPSIL,IPENALTY,AKN,AKS
      IF(NTSF.LE.0) NTSF=1
      IF(EPSIL.LE.1.D-20) EPSIL=1.D-8
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2000)NTSF,FMSTAT,FMDIN,EPSIL,IPENALTY,AKN,AKS
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6000)NTSF,FMSTAT,FMDIN,EPSIL,IPENALTY,AKN,AKS
C
CS     REPERI U VEKTORU ZA ULAZNE PODATKE
CE     POINTERS IN INPUT VECTOR
C
      NCVE=4
      LFSFD =1
      LNCVSF=LFSFD +NE*2*IDVA
      LITSRF=LNCVSF+NTSF
      LISNA =LITSRF+NTSF
      LNEL  =LISNA +NTSF
      LIDC  =LNEL  +NE*2
C SNEZA
      IF(IPENALTY.EQ.0)THEN
      	LMXAU =LIDC+NE*3
      ELSE
      	LMXAU =LIDC
      END IF
C SNEZA      
C      
      LAU   =LMAX
      LNELSF=LMXAU
C... KONTROLA MEMORIJE			   
      CALL CTRREP(LMAX,LAU,LMXAU,MTOT)
C
CS     POZIVANJE PROGRAMA ZA ULAZNE PODATKE U VEKTOR AU
CE     CALL ROUTINES FOR INPUT DATA IN VECTOR  AU
C
      CALL UL93EK(A(LAU))
      NCVE36=NCVE*3+6
      MXAE = 100*IDVA+NCVE36
      MMMM = NTTOT*3*IDVA+2*NWKCDY*IDVA+NCVE36+NCVE*NCVE+NCVE
      IF(NDIN.NE.0) MXAE = MAX0(MXAE,MMMM)
      LMAX = LMAX + MXAE
      RETURN
C
 1010 FORMAT(I5,5X,3F10.0,I5,5X,2F10.0)
C-----------------------------------------------------------------------
 2000 FORMAT(///
     611X,'UKUPAN BROJ CILJNIH POVRSINA ..................   NTSF =',I5/
     616X,'EQ.0; NTSF = 1'///
     7//
     711X,'REFERENTNI STATICKI KOEFICIJENT TRENJA ... FMSTAT =',1PD10.3/
     711X,'REFERENTNI DINAMICKI KOEFICIJENT TRENJA .. FMDIN  =',1PD10.3/
     7/
     711X,'TOLERANCIJA KONTAKTNOG PRODORA ........... EPSIL  =',1PD10.3/
     616X,'EQ.0; EPSIL = 1.E-08'/
     711X,'TIP KONTAKTA ............................ IPENALTY=',I5/
     616X,'EQ.0; LAGRANZEOVI MNOZIOCI'/
     616X,'EQ.1; PENALTI'/
     711X,'NORMALNA KRUTOST ............................. AKN=',1PD10.3/
     711X,'SMICUCA KRUTOST .............................. AKS=',1PD10.3/
     6//)
C-----------------------------------------------------------------------
 6000 FORMAT(///
     611X,'TOTAL NUMBER OF TARGET SURFACES ...............   NTSF =',I5/
     616X,'EQ.0; NTSF = 1'///
     7//
     711X,'REFERENT STATIC FRICTION COEFFICIENT ..... FMSTAT =',1PD10.3/
     711X,'REFERENT DYNAMIC FRICTION COEFFICIENT .... FMDIN  =',1PD10.3/
     7/
     711X,'CONTACT ROUND-OFF TOLERANCE .............. EPSIL  =',1PD10.3/
     616X,'EQ.0; EPSIL = 1.E-08'/
     711X,'TYPE OF CONTACT ............................ IPENALTY=',I5/
     616X,'EQ.0; LAGRANGE MULTIPLIER METHOD'/
     616X,'EQ.1; PENALTY METHOD'/
     711X,'NORMAL STIFFNESS ............................. AKN=',1PD10.3/
     711X,'TANGENTIAL STIFFNESS ......................... AKS=',1PD10.3/
     6//)
C-----------------------------------------------------------------------
      END
C=======================================================================
      SUBROUTINE UL93EK(AU)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS     GLAVNI UPRAVLJACKI PROGRAM ZA UCITAVANJE ULAZNIH PODATAKA U AU
CE     MENAGEMENT PROGRAM FOR INPUT DATA IN  AU  VECTOR
C
      include 'paka.inc'
      
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      COMMON /SISTEM/ LSK,LRTDT,NWK,JEDN,LFTDT
      COMMON /ELEMAU/ MXAU,LAU,LLMEL,LNEL,LNMAT,LTHID,LIPGC,LIPRC,LISNA,
     1 LMXAU,LAPRS
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /DUZINA/ LMAX,MTOT,LMAXM,LRAD,NRAD
      COMMON /REPERI/ LCORD,LID,LMAXA,LMHT
      COMMON /DUPLAP/ IDVA
      COMMON /PLASTI/ LPLAST,LPLAS1,LSIGMA
      COMMON /POSTPR/ LNDTPR,LNDTGR,NBLPR,NBLGR,INDPR,INDGR
      COMMON /MATERM/ LMODEL,LGUSM
      COMMON /RESTAR/ TSTART,IREST
      COMMON /ORIENT/ CPP(3,3),XJJ(3,3),TSG(6,6),BETA,LBET0,IBB0
      COMMON /KONTKT/ ICONT,NEQC,NEQ,NWKC,LMAXAC,LRCTDT
      COMMON /KONTK3/ FMSTAT,FMDIN,EPSIL,NTSF,NTTOT,LNCVSF,LITSRF,
     &                LNELSF,LIDC,LIK,LIK1,LFSFD,LMASE,LNELAB,NWKCDY
      COMMON /CVOREL/ ICVEL,LCVEL,LELCV,NPA,NPI,LCEL,LELC,NMA,NMI
      COMMON /PENALTY/ AKN,AKS,IPENALTY
C
      DIMENSION AU(*)
      REAL AU
C
CS     POZIVANJE PROGRAMA ZA ULAZNE PODATKE O 3/D KONTAKT ELEMENTIMA
CE     CALL ROUTINE FOR INPUT DATA ABOUT 3/D CONTACT ELEMENTS
C
      NE2=NE*2
      CALL ICLEAR(AU(LNEL),NE2)
      CALL UL931(AU(LNCVSF),AU(LITSRF),AU(LISNA),AU(LNELSF),AU(LNEL),
     &           AU(LFSFD),A(LCVEL))
      LL=LNELAB-LNELSF
      MXAU =LNELAB+LL
      CALL CTRREP(LMAX,LAU,MXAU,MTOT)
C
C  LOKALNA NUMERACIJA CILJNIH KONTAKTNIH CVOROVA
C
      CALL ICLEAR(AU(LNELAB),LL)
      CALL NUMC93(AU(LNELSF),AU(LNELAB),AU(LNCVSF),
     &            NTSF,NTTOT,NUMEL,NCVE)
C  vrednost nttot za penalty   - proveri ovu vrednost za dinamiku ???
C      IF(IPENALTY.EQ.1) NTTOT=15
C
C  REPERI ZA DINAMIKU
C
      LMASE =MXAU
      IF(NDIN.GT.0)THEN
       IF(MOD(LMASE,2).EQ.0) LMASE=LMASE+1
       LNGLOB=LMASE+(NE+NTTOT)*IDVA
       LJDIAG=LNGLOB+NTTOT
       MXAU  =LJDIAG+NTTOT
       CALL CTRREP(LMAX,LAU,MXAU,MTOT)
C
C  PROFIL SISTEMA ZA DINAMIKU (IMPULSE-MOMENTUM BALANCE)
C
        NUMEL=LL/NCVE
        IF(NDIN.NE.0)
     &   CALL PROF93(AU(LJDIAG),AU(LNELAB),AU(LNELSF),AU(LNGLOB),
     &               NTTOT,NUMEL,NCVE,NWKCDY)
      ENDIF
C
      MXAU=MXAU-1
      IF(MOD(MXAU,2).NE.0) MXAU=MXAU+1
      CALL CTRREP(LMAX,LAU,MXAU,MTOT)
C
C  GRAFICKI IZLAZ ZA ULAZNE PODATKE
C
      IF(NBLGR.GE.0) 
     &  CALL TGRF93(AU(LNCVSF),AU(LITSRF),AU(LNELSF),
     &              AU(LISNA),AU(LNEL),A(LCVEL),ICVEL)
C
CS     FORMIRANJE VEKTORA LM
CE     FORM  LM  VECTOR
C
      NE3=NE*3
C SNEZA
      IF(IPENALTY.EQ.0)THEN
      CALL LMMH93(A(LID),AU(LNEL),AU(LIDC),AU(LNCVSF),AU(LITSRF),
     &            AU(LNELSF))
      ELSEIF(IPENALTY.EQ.1)THEN 
	CALL LMMH93P(A(LID),AU(LNEL),AU(LNCVSF),AU(LITSRF),
     &            AU(LNELSF),AU(LISNA))    
      ENDIF
C SNEZA      	
C
      LMAX8=LMAX8+1
      WRITE(IELEM,REC=LMAX8)
     1 NTSF,NTTOT,NCVE,MXAU,NWKCDY,LNCVSF,LITSRF,
     1 LISNA,LNELSF,LNEL,LLMEL,LFSFD,LMASE,LNELAB,EPSIL
      CALL WRITDD(AU(LFSFD),MXAU/IDVA,IELEM,LMAX8,LDUZI)
      IF(MOD(LMAX,2).EQ.0) LMAX=LMAX+1
CS....  PROSTOR ZA VELICINE PRETHODNOG KORAKA
CE....  SPACE FOR PREVIOUS STEP VALUES
      NPROS=(NE3+1)/2*2/IDVA+5*NE
      LIK  =LMAX
      LIK1 =LIK +NE
      IF(MOD(LIK1,2).EQ.0) LIK1=LIK1+1
      LMAX =LIK1+2*NE+5*NE*IDVA
      IF(LMAX.GT.MTOT) CALL ERROR(1)
CS..... PROSTOR ZA VELICINE TEKUCEG KORAKA
      IF(IREST.NE.1) THEN
        CALL ICLEAR(A(LIK) ,NE3)
C        CALL ICLEAR(A(LIK1),NE)
        CALL WRITDD(A(LIK),NPROS,IELEM,LMAX8,LDUZI)
      ELSE
        CALL READDD(A(LIK),NPROS,IELEM,LMAX8,LDUZI)
      ENDIF
CS      KONTAKTNE SILE
CE      CONTACT FORCES
      LSIGMA=LMAX
      NPROS =(NE+NTTOT)*3
      NPRO2 =2*NPROS
      LMAX  =LSIGMA+NPRO2*IDVA
      IF(IREST.NE.1) THEN
        CALL CLEAR (A(LSIGMA),NPRO2)
        CALL WRITDD(A(LSIGMA),NPRO2,IELEM,LMAX8,LDUZI)
      ELSE
        CALL READDD(A(LSIGMA),NPRO2,IELEM,LMAX8,LDUZI)
      ENDIF
      RETURN
      END
C======================================================================
      SUBROUTINE UL931(NCVSF,ITSRF,ISNA,NELSF,NEL,FSFD,NCVEL)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS     PODPROGRAM ZA UCITAVANJE PODATAKA O 3-D KONTAKTNIM ELEMENTIMA
CE     SUBROUTINE FOR READING DATA ABOUT 3-D CONTACT ELEMENTS
C
C   ISNA()  -  MAX. BROJ CVOROVA POLIGONA NA CILJNIM SEGMENTIMA
C
      include 'paka.inc'
      
      CHARACTER*250 ACOZ
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /DUZINA/ LMAX,MTOT,LMAXM,LRAD,NRAD
      COMMON /ELEMAU/ MXAU,LAU,LLMEL,LNEL,LNMAT,LTHID,LIPGC,LIPRC,LISNA,
     1 LMXAU,LAPRS
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /ORIENT/ CPP(3,3),XJJ(3,3),TSG(6,6),BETA,LBET0,IBB0
      COMMON /REPERI/ LCORD,LID,LMAXA,LMHT
      COMMON /KONTK3/ FMSTAT,FMDIN,EPSIL,NTSF,NTTOT,LNCVSF,LITSRF,
     &                LNELSF,LIDC,LIK,LIK1,LFSFD,LMASE,LNELAB,NWKCDY
      COMMON /SRPSKI/ ISRPS
      COMMON /CVOREL/ ICVEL,LCVEL,LELCV,NPA,NPI,LCEL,LELC,NMA,NMI
      COMMON /PENALTY/ AKN,AKS,IPENALTY
C
      DIMENSION NCVSF(*),ITSRF(*),ISNA(*),NELSF(NCVE,*),NEL(NE,*),
     &          FSFD(NE,*),XP(3),NCVEL(*)
C
CS     P O D A C I   O   C I L J N I M    3-D    P O V R S I M A
CE     D A T A   A B O U T   T A R G E T   3-D   S U R F A C E S
C
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2000) NGE
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6000) NGE
C
      LMXAU=LNELSF
      NNE=1
      DO 10 ITS=1,NTSF
      CALL ISPITA(ACOZ)
      IF(ITS.EQ.1) KARTI=KARTIC
C  NN  REDNI BROJ SEGMENTA
C  NCVSF   BROJ PODSEGEMENATA
C  ITSRF   TIP SEGMENTA
C  MAXCE   MAKSIMALAN BROJ CVOROVA
C  IORI    INDIKATOR ORIJENTACIJE NORMALA
C          .EQ.0  - KAKO JE UNETO, IGNORISE SE POMOCNA TACKA
C          .LT.0  - KONTRA OD POMOCNE TACKE (XP)
C          .GT.0  - ORIJENATCIJA KA POMOCNOJ TACKI (XP)
C  KORC    KORAK GENERISANJA
      IF(INDFOR.EQ.1)
     1READ(IULAZ,*)   NN,NCVSF(NN),ITSRF(NN),MAXCE,IORI,KORC,XP
      IF(INDFOR.EQ.2)
     1READ(ACOZ,1000) NN,NCVSF(NN),ITSRF(NN),MAXCE,IORI,KORC,XP
      IF(MAXCE.EQ.0) MAXCE=4
      ISNA(NN)=MAXCE
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2001) NN,NCVSF(NN),ITSRF(NN),ISNA(NN),IORI,KORC
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6001) NN,NCVSF(NN),ITSRF(NN),ISNA(NN),IORI,KORC
      IF(IORI.NE.0.AND.ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2002) XP
      IF(IORI.NE.0.AND.ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6002) XP
      NC=NCVSF(NN)
C... KOREKCIJA REPERA
      NNEOLD=NNE-1
      ITSRF(NN)=NNE
      NNE  =NNE+NC
      IDUM =NC*NCVE
      LMXAU=LMXAU+IDUM
C... KONTROLA MEMORIJE			   
      CALL CTRREP(LMAX,LAU,LMXAU,MTOT)
      CALL ICLEAR(NELSF(1,NNEOLD+1),IDUM)
       II1=NNEOLD+1
      IF(KORC.EQ.0)THEN
       DO 4 I=NNEOLD+1,NNEOLD+NC
        CALL ISPITA(ACOZ)
        IF(INDFOR.EQ.1)
     1  READ(IULAZ,*)   (NELSF(L,I),L=1,MAXCE)
        IF(INDFOR.EQ.2)
     1  READ(ACOZ,1000) (NELSF(L,I),L=1,MAXCE)
    4  CONTINUE
      ELSE
        CALL ISPITA(ACOZ)
        IF(INDFOR.EQ.1)
     1  READ(IULAZ,*)   (NELSF(L,II1),L=1,MAXCE)
        IF(INDFOR.EQ.2)
     1  READ(ACOZ,1000) (NELSF(L,II1),L=1,MAXCE)
        DO 7 I=NNEOLD+2,NNEOLD+NC
        DO 6 LL=1,4
    6   NELSF(LL,I)=NELSF(LL,I-1)+KORC
    7   CONTINUE
      ENDIF
C
      IF(ICVEL.EQ.1) THEN
        DO 13 I=NNEOLD+1,NNEOLD+NC
CC13      CALL VEZACE(NELSF(1,I),A(LELCV),MAXCE,NCVSF(NN))
13      CALL VEZACE(NELSF(1,I),A(LELCV),MAXCE,1)
      ENDIF
C
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2005)
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6005)
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3)THEN
        DO 15 I=NNEOLD+1,NNEOLD+NC
        IF(IORI.NE.0)THEN
C... PROVERA ORIJENTACIJE PREMA POMOCNOJ TACKI
          ICHOR = IORSRF(XP,A(LCORD),NELSF(1,I),NP,MAXCE)
C        IF(ICHOR.LT.0)WRITE(3,*)' ***',(NELSF(L,I),L=1,MAXCE)
C... IZMENA ORIJENTACIJE
          IF(IORI*ICHOR.LT.0) CALL ORINOD(NELSF,NCVE,MAXCE,I)
        ENDIF
        IF(ICVEL.EQ.0)THEN
          WRITE(IZLAZ,1005) (NELSF(L,I),L=1,MAXCE)
        ELSEIF(ICVEL.EQ.1)THEN
          WRITE(IZLAZ,1005) (NCVEL(NELSF(L,I)),L=1,MAXCE)
        ENDIF
   15   CONTINUE
      ENDIF
   10 CONTINUE
C
C... REPER ZA LOKALNU NUMERACIJU KONTAKTNIH CVOROVA
C
      LNELAB=LMXAU
      LMXAU =LNELAB+(LNELAB-LNELSF)
      CALL CTRREP(LMAX,LAU,LMXAU,MTOT)
C
CS     P O D A C I   O   K O N T A K T N I M   E L E M E N T I M A
CE     D A T A   A B O U T   C O N T A C T   E L E M E N T S
C
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2010)
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6010)
C
C
      I = 0
      NAUT=0
    5 I=I+1
      CALL ISPITA(ACOZ)
      IF(I.EQ.1) KARTI=KARTIC
      IF(INDFOR.EQ.1)
     1READ(IULAZ,*) (NEL(I,J),J=1,2),(FSFD(I,J),J=1,2),KORC
      IF(INDFOR.EQ.2)
     1READ(ACOZ,1020) (NEL(I,J),J=1,2),(FSFD(I,J),J=1,2),KORC
      FSFD(I,1)=FMSTAT*FSFD(I,1)
      FSFD(I,2)=FMDIN *FSFD(I,2)
      IF((NULAZ.EQ.1.OR.NULAZ.EQ.3).AND.(NAUT.EQ.0))
     1WRITE(IZLAZ,1030) (NEL(I,J),J=1,2),(FSFD(I,J),J=1,2),KORC
      IF(NAUT.GT.0) GO TO 30
      IF(KORC.NE.0) GO TO 20
      IF(I.EQ.NE) GO TO 50
      GO TO 5
C
   20 NAUT=1
      N1=NEL(I,1)
      KORA=KORC
      GO TO 5
C
CE    AUTOMATIC GENERATE DATA BETWEEN NODAL POINT N1 AND N2
CS    AUTOMATSKO GENERISANJE PODATAKA IZMEDJU CVOROVA N1 I N2
C
   30 N2=NEL(I,1)
      CALL DELJIV(N2-N1,KORA,INDD)
      IF(INDD.EQ.1) GO TO 100
      RKORA = KORA
      RN1N2 = N2-N1
      DD = RKORA/RN1N2
      IF(DD.LT.0.0D00) GO TO 100
      IAUT=(N2-N1)/KORA-1
      N = I-1
      IIAUT=I+IAUT
      NEL(IIAUT,1)=NEL(I,1)
      NEL(IIAUT,2)=NEL(I,2)
      FSFD(IIAUT,1)=FSFD(I,1)
      FSFD(IIAUT,2)=FSFD(I,2)
      DO 34 J=1,IAUT
      NEL(I,1)=NEL(I-1,1)+KORA
      NEL(I,2)=NEL(N,2)
      FSFD(I,1)=FSFD(N,1)
      FSFD(I,2)=FSFD(N,2)
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3)
     1WRITE(IZLAZ,1030) (NEL(I,JJ),JJ=1,2),(FSFD(I,JJ),JJ=1,2)
      I=I+1
   34 CONTINUE
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3)
     1WRITE(IZLAZ,1030) (NEL(IIAUT,JJ),JJ=1,2),(FSFD(IIAUT,JJ),JJ=1,2)
      IF(I.EQ.NE)THEN
        GO TO 50
      ENDIF
      NAUT=0
      IF(KORC.EQ.0)THEN
        GO TO 5
      ENDIF
      KORA=KORC
      NAUT=1
      N1=N2
      GO TO 5
C
  50  IF(ICVEL.EQ.1) CALL VEZACE(NEL,A(LELCV),NE,1)
      RETURN

  100 CONTINUE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2100) N2,N1,KORA
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6100) N2,N1,KORA
      STOP 'PROGRAM STOP: PAK021 - ULAZE1'

 2100 FORMAT(///' BROJ N2=',I5,' NE MOZE SE DOBITI SABIRANJEM BROJA N1='
     1,I5,' I KONACNOG BROJA KORAKA KORA=',I5)
 6100 FORMAT(///' NUMBER N2=',I5,' HAS NOT OBTAIN BY THE SUM OF NUBMBER
     1N1 =',I5,'AND FINITE NUMBER OF STEPS KORA=',I5)
C
C
C
C     DO 20 NN=1,NE
C     CALL ISPITA(ACOZ)
C     IF(INDFOR.EQ.1)
C    1READ(IULAZ,*) (NEL(NN,J),J=1,2),(FSFD(NN,J),J=1,2)
C     IF(INDFOR.EQ.2)
C    1READ(ACOZ,1020) (NEL(NN,J),J=1,2),(FSFD(NN,J),J=1,2)
C     FSFD(NN,1)=FMSTAT*FSFD(NN,1)
C     FSFD(NN,2)=FMDIN *FSFD(NN,2)
C     IF(NULAZ.EQ.1.OR.NULAZ.EQ.3)
C    1WRITE(IZLAZ,1030) (NEL(NN,J),J=1,2),(FSFD(NN,J),J=1,2)
C  20 CONTINUE
C
 1000 FORMAT(6I5,3F10.3)
 1005 FORMAT(10X,4I5)
 1020 FORMAT(2I5,2F10.3,I5)
 1030 FORMAT(2I10,8X,D12.5,3X,D12.5,I5)
C-----------------------------------------------------------------------
 2000 FORMAT(///,' UCITANI PODACI O KONTAKT ELEMENTIMA GRUPE ELEMENATA',
     1I6/1X,57('-'))
 2001 FORMAT(///6X,'SEGMENT',6X,'BROJ',6X,'TIP',5X,'MAX.CV',2X,
     2'ORIJENT.',5X,'KORAK'/8X,'BROJ',5X,'POLIGONA'/
     3 5X,I5,6X,I6,3X,I6,4X,I6,4X,I6,4X,I6)
 2002 FORMAT(///6X,'ORIJENTACIJA NORMALA: ',3(D12.5,2X))
 2005 FORMAT(//6X,'CVOR   N1   N2   N3   N4')
 2010 FORMAT(//6X,'KONTAKTNI PAROVI            KOEFICIJENTI TRENJA',
     +'    KORAK'
     1       //6X,'CVOR   CILJNI SEGMENT     STATICKI      DINAMICKI')
C-----------------------------------------------------------------------
 6000 FORMAT(///,' INPUT DATA ABOUT CONTACT ELEMENTS OF ELEMENTS GROUP',
     1I6/1X,57('-'))
 6001 FORMAT(///6X,'SEGMENT',6X,'NUMB',6X,'TYP',5X,'MAX.NO',2X,
     2'ORIJENT.',5X,' STEP'/8X,'NUMB',5X,'POLYGONS'/
     3 5X,I5,6X,I6,3X,I6,4X,I6,4X,I6,4X,I6)
 6002 FORMAT(///6X,'ORIENTATION POINT: ',3(D12.5,2X))
 6005 FORMAT(//6X,'NODE   N1   N2   N3   N4')
 6010 FORMAT(//6X,'CONTACT PAIRS(ELEMENTS)     FRICTION COEFFICIENT',
     +'     STEP'
     1       //6X,'NODE   TARGET SEGMENT     STATIC        DYNAMIC  ')
C-----------------------------------------------------------------------
      END
C=======================================================================
      SUBROUTINE LMMH93(ID,NEL,IDC,NCVSF,ITSRF,NELSF)
C
CS     FORMIRANJE VEKTORA LM I VISINA STUBOVA (MHT)
CE     OBTAIN VECTOR  LM   AND COLUMN HEIGHTS
C
      include 'paka.inc'
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /SISTEM/ LSK,LRTDT,NWK,JEDN,LFTDT
      COMMON /REPERI/ LCORD,LID,LMAXA,LMHT
      COMMON /KONTKT/ ICONT,NEQC,NEQ,NWKC,LMAXAC,LRCTDT
      COMMON /GEORGE/ TOLG,ALFAG,ICCGG
      COMMON /DRAKCE/ IDRAKCE,NELUK,NZERO,NEED1,NEED2,NEED3,NNZERO
     1                ,IROWS,LAILU,LUCG,LVCG,LWCG,LPCG,LRCG
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /SRPSKI/ ISRPS
C
      DIMENSION ID(NP,*),NEL(NE,*),IDC(NE,*),NCVSF(*),ITSRF(*),NELSF(*),
     &          LMEL(30)
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2025)
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6025)
C  FORMIRANJE DOPUNSKIH JEDNACINA ZA LAGRANZEV MNOZIOC
C  PETLJA PO KONTAKTNIM ELEMENTIMA (CVOROVIMA KONTAKTORA)
      CALL ICLEAR(LMEL,30)
      ND=NCVE*3
      DO 100 NLM=1,NE
       JJ=NEL(NLM,1)
       DO 5 I=1,3
       IF(ID(JJ,I).GT.0)THEN
         JEDN=JEDN+1
         IDUM=JEDN
       ELSE
         IDUM=0
       ENDIF
       IDC(NLM,I)=IDUM
    5  LMEL(I)=IDC(NLM,I)
C  VEZA SA KONTAKTOR TELOM
       DO 7 I=1,3
    7  LMEL(I+3)=ID(JJ,I)
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3)
     1   WRITE(IZLAZ,5030)JJ,(IDC(NLM,I),I=1,3)
C     FORMIRANJE VISINA STUBOVA
        CALL VISINE(A(LMHT),ND,LMEL)
      IF (IABS(ICCGG).EQ.1) THEN
         WRITE(IDRAKCE) ND,(LMEL(I),I=1,ND)
         NELUK=NELUK+1
      ENDIF
C
C  PETLJA PO CVROVIMA CILJNOG SEGMENTA
       ISRF=NEL(NLM,2)
       NNC =NCVSF(ISRF)
       LL  =(IABS(ITSRF(ISRF))-1)*NCVE
        NC3=0
        DO 10 NC=1,NNC
        DO 9  J3=1,NCVE
         NC3=NC3+1
         JJ=NELSF(LL+NC3)
         IF(JJ.EQ.0)GO TO 9
         DO 20 I=1,3
   20     LMEL(I+3)=ID(JJ,I)
C     FORMIRANJE VISINA STUBOVA
        CALL VISINE(A(LMHT),ND,LMEL)
      IF (IABS(ICCGG).EQ.1) THEN
         WRITE(IDRAKCE) ND,(LMEL(I),I=1,ND)
         NELUK=NELUK+1
      ENDIF
    9   CONTINUE
   10   CONTINUE
  100 CONTINUE
C
      NEQC=JEDN-NEQ
C
C      WRITE(3,*)'***NEQ,NEQC,JEDN',NEQ,NEQC,JEDN
 5030 FORMAT(11X,I5,3I5)
 2025 FORMAT(//11X,' CVOR    JEDNACINE')
 6025 FORMAT(//11X,' NODE    EQUATIONS')
      RETURN
      END
C=======================================================================
      SUBROUTINE TGRF93(NCVSF,ITSRF,NELSF,ISNA,NEL,NCVEL,ICVEL)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
CS     PROGRAM ZA STAMPANJE STAPA  U UNIVERZALNI FILE
CE     PROGRAM FOR PRINTOUT DATA IN UNIVERSAL GRAPHICS FILE
C
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /KONTK3/ FMSTAT,FMDIN,EPSIL,NTSF,NTTOT,LNCVSF,LITSRF,
     &                LNELSF,LIDC,LIK,LIK1,LFSFD,LMASE,LNELAB,NWKCDY
      COMMON /SUMELE/ ISUMEL,ISUMGR
      DIMENSION NCVSF(*),ITSRF(*),NELSF(*),ISNA(*),NEL(NE,*),NCVEL(*)
C   TABELA FIZICKIH OSOBINA
      IPTN=NGE
C   TABELA MATERIJALA
      MPTN=NMODM
C   BOJA  
      ICOL=8
C   BROJ CVOROVA NA ELEMENTU
      IND=-1
      ITYP=71
      WRITE(IGRAF,1100) IND
      WRITE(IGRAF,1100) ITYP
C
C ... KONTAKTOR CVOROVI
CC      NNODS=2
CC      DO 5 I=1,NE
CCC   GRAFICKI OPIS - STAP
CC        IFGD=1
CC        IFDI=11
CC        IEL=I+ISUMEL
CC        IF(ICVEL.EQ.0)THEN
CC          NCC=NEL(I,1)
CC        ELSEIF(ICVEL.EQ.0)THEN
CC          NCC=NCVEL(NEL(I,1))
CC        ENDIF
CC        WRITE(IGRAF,1000)IEL,IFGD,IFDI,IPTN,MPTN,ICOL,NNODS
CC        WRITE(IGRAF,1000)NCC,NCC
CC5     CONTINUE
CC      ISUMEL=ISUMEL+NE
CCC
      DO 10 ITS=1,NTSF
C   REDNI BROJ ELEMENTA
      IEL=ITS+ISUMEL
      NNODS=ISNA(ITS)
      NNC =NCVSF(ITS)
      LL  =(IABS(ITSRF(ITS))-1)*NCVE
C   GRAFICKI OPIS
      IF(NNODS.EQ.4)THEN
        IFGD=5
        IFDI=44
      ELSEIF(NNODS.EQ.3)THEN
        IFGD=2
        IFDI=91
      ELSEIF(NNODS.EQ.2)THEN
        IFGD=1
        IFDI=14
      ENDIF
C      WRITE(IGRAF,1100) IND
C      WRITE(IGRAF,1100) ITYP
      DO 8 J=1,NNC
        ISUMEL=ISUMEL+1
        WRITE(IGRAF,1000)ISUMEL,IFGD,IFDI,IPTN,MPTN,ICOL,NNODS
        IF(ICVEL.EQ.0)THEN
          WRITE(IGRAF,1000)(NELSF(JJ),JJ=LL+1,LL+NNODS)
        ELSEIF(ICVEL.EQ.1)THEN
          WRITE(IGRAF,1000)(NCVEL(NELSF(JJ)),JJ=LL+1,LL+NNODS)
        ENDIF
        LL=LL+NCVE
    8 CONTINUE
C      WRITE(IGRAF,1100) IND
CC      ISUMEL=ISUMEL+NTSF
   10 CONTINUE
      WRITE(IGRAF,1100) IND
      RETURN
 1000 FORMAT(8I10)
 1100 FORMAT(I6)
      END
C=======================================================================
      SUBROUTINE NUMC93(NELSF,NELAB,NCVSF,NTSF,NTTOT,NUMEL,NCVE)
C
C  LOKALNA NUMERACIJA ZA KONTAKTNU GRUPU ELEMENATA
C
      DIMENSION NCVSF(*),NELSF(*),NELAB(*)
      NN=0
      KK=0
      DO 20 ITS=1,NTSF
      NC=NCVSF(ITS)
       DO 10 I=1,NC
       NN=NN+1
       DO 5 L=1,NCVE
        KK=KK+1
        NELSF(KK)=-NELSF(KK)
    5  CONTINUE
   10 CONTINUE
   20 CONTINUE
      NUMEL=NN
C
      NNEW=0
      DO 40 N=1,KK
       IF(NELSF(N).LT.0)THEN
         NNEW=NNEW+1
         NOLD=NELSF(N)
         NOMI=-NOLD
         DO 30 J=N,KK
          IF(NELSF(J).EQ.NOLD)THEN
            NELAB(J)=NNEW        
            NELSF(J)=NOMI
          ENDIF
   30    CONTINUE
       ENDIF
   40 CONTINUE
      NTTOT=NNEW
      RETURN
      END
C=======================================================================
      SUBROUTINE CTRREP(LMAX,L0,LMX,MTOT)
C... KONTROLA MEMORIJE
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /SRPSKI/ ISRPS
      MX = LMX - 1
      IF(MOD(MX,2).NE.0) MX=MX+1
      LMAX=L0+MX
      IF (LMAX.LE.MTOT) GO TO 5
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2010) LMAX,MTOT
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6010) LMAX,MTOT
      STOP
    5 RETURN
 2010 FORMAT(///' NEDOVOLJNA DIMENZIJA U VEKTORU A ZA MATRICE ELEMENATA'
     1/' POTREBNA DIMENZIJA,    LMAX=',I10
     2/' RASPOLOZIVA DIMENZIJA, MTOT=',I10)
 6010 FORMAT(///' NOT ENOUGH SPACE IN WORKING VECTOR  A'
     1/' REQUESTED DIMENSION , LMAX=',I10
     2/' AVAILABLE DIMENSION , MTOT=',I10)
      END
C=======================================================================
      SUBROUTINE ORINOD(NELSF,NCVE,MAXCE,I)
C... IZMENA REDOSLEDA CVOROVA / ORIJENTACIJA NORMALE
      DIMENSION NELSF(NCVE,*)
      IF(MAXCE.EQ.2)THEN
        N1=NELSF(1,I)
        NELSF(1,I)=NELSF(2,I)
        NELSF(2,I)=N1
      ELSEIF(MAXCE.EQ.3)THEN
        N1=NELSF(2,I)
        NELSF(2,I)=NELSF(3,I)
        NELSF(3,I)=N1
      ELSEIF(MAXCE.EQ.4)THEN
        N1=NELSF(1,I)
        NELSF(1,I)=NELSF(2,I)
        NELSF(2,I)=N1
        N1=NELSF(3,I)
        NELSF(3,I)=NELSF(4,I)
        NELSF(4,I)=N1
      ENDIF
      RETURN
      END
C=======================================================================
      FUNCTION IORSRF(XP,CORD,NELSF,NP,MAXCE)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C... PROVERA ORIJENTACIJE PREMA POMOCNOJ TACKI
      DIMENSION CORD(NP,*),NELSF(*),XP(*),A(3),B(3),AN(3),P(3)
      IORSRF=1
      IF(MAXCE.EQ.3.OR.MAXCE.EQ.4)THEN
        N1=NELSF(1)
        N2=NELSF(2)
        N3=NELSF(3)
        DO 10 I=1,3
          A(I) = CORD(N2,I)-CORD(N1,I)
          B(I) = CORD(N3,I)-CORD(N2,I)
          P(I) = XP(I)-CORD(N1,I)
   10   CONTINUE
        CALL AXBV( A, B, AN )
        IF(AOBS(P,AN).LT.0.D0) IORSRF=-1
      ELSEIF(MAXCE.EQ.2)THEN
        WRITE(3,*)' PAK931:IORSRF    NIJE PODRZANO ZA 2D ELEMENTE'
      ENDIF
      RETURN
      END
