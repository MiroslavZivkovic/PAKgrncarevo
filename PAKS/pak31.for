C=======================================================================
C
CE        READING DATA ABOUT 3/D ELEMENTS
CS        UCITAVANJE PODATAKA O 3/D ELEMENTIMA
C
C   SUBROUTINE UL3EGL
C              UL3EK
C              UL3EK3
C              UL3EKC
C              LM3MHT
C              UCGRP3
C              PSPOL3
C              TGRAF3
C
C=======================================================================

      SUBROUTINE UL3EGL
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C ......................................................................
C .
CE.   P R O G R A M
CE.      TO FORM POINTERS AND READING INPUT DATA ABOUT 3/D ELEMENTS
CS.   P R O G R A M
CS.      ZA FORMIRANJE REPERA I UCITAVANJE OPSTIH ULAZNIH PODATAKA
CS.      O ELEMENTIMA: 3/D, PRIZMA, PIRAMIDA, TRIEDAR
C .
CE.    P O I N T E R S
CE.       LTBTH - TIME OF ELEMENT BIRTH IF (INDBTH.GT.0.), 
CE.               SEE CARDS /13/ AND /13-3/(B) USER MANUAL
CE.       LTDTH - TIME OF ELEMENT DEATH IF (INDDTH.GT.0.),
CE.               SEE CARDS /13/ AND /13-3/(B) USER MANUAL
CE.       LNMAT - ELEMENT MATERIAL SET NUMBER WITHIN MATERIAL MODEL,
CE.               /13-3/(B)
CE.       LIPGC - INDICATOR FOR INTERNAL FORCE OF ELEMENT NODAL POINTS
CE.       LISNA - INDICATOR FOR STRESS PRINTOUT, /13-3/(B)
CE.       LIPRC - INDICATOR FOR INTEGRATION COORDINATES PRINTOUT,
CE.       LNEL  - NODES FOR ELEMENT, /13-3/(C1) AND  /13-3/(C2)
CE.       LCEL  - USED FOR FREE ELEMENT NUMERATION, IF (ICVEL.EQ.1)
CE.               SEE CARD /4/
CE.       LAU   - POINTER FOR ARRAY AU(*) USED FOR READING OF ELEMENT
CE.               INPUT DATA AND  INITIALIZATION
C .
CE.    V A R I A B L E S
CE.       NE    - NUMBER OF ELEMENTS IN THE ELEMENT GROUP, SEE CARD /13/
CE.       NCVE  - MAXIMUM NUMBER OF NODES PER ELEMENT
CE.       ND    - NUMBER OF D.O.F PER 3D ELEMENT
C .
C ......................................................................
C
      CHARACTER*250 ACOZ
      include 'paka.inc'
      
      COMMON /IZOL4B/ NGS12,ND,MSLOJ,MXS,MSET,LNSLOJ,LMATSL,LDSLOJ,LBBET
      COMMON /ELEMAU/ MXAU,LAU,LLMEL,LNEL,LNMAT,LTHID,LIPGC,LIPRC,LISNA,
     1 LMXAU,LAPRS
      COMMON /SIMO2D/ LALFE,LHAEM,LHINV,LGEEK,IALFA
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /DUZINA/ LMAX,MTOT,LMAXM,LRAD,NRAD
      COMMON /DUPLAP/ IDVA
      COMMON /ORIENT/ CPP(3,3),XJJ(3,3),TSG(6,6),BETA,LBET0,IBB0
      COMMON /UCORIJ/ IORT
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /BTHDTH/ INDBTH,INDDTH,LTBTH,LTDTH
      COMMON /CVOREL/ ICVEL,LCVEL,LELCV,NPA,NPI,LCEL,LELC,NMA,NMI
      COMMON /INTGRA/ INCOTX,INCOTY,INCOTZ
      COMMON /PROLAZ/ IVEZA
      COMMON /SRPSKI/ ISRPS
      COMMON /PODTIP/ IPODT
      COMMON /CRACKS/ CONTE,SINTE,FK123(10,3),NODCR(10,14),NCRACK,LQST,
     1                LNERING,LMIE,LPSI,LQ,N100,IRING,NSEG,MAXRIN,MAXSEG
     1                ,MAXNOD,LXL,LYL,LZL,LSIF1,LXGG,LYGG,LZGG,LNNOD
      COMMON /CDEBUG/ IDEBUG
C
      IF(IDEBUG.GT.0) PRINT *, ' UL3EGL'
C
CE    BASIC DATA ABOUT ELEMENTS
CS    OSNOVNI PODACI O ELEMENTIMA
C
      CALL CLEAR(CPP,9)
      CALL CLEAR(TSG,36)
      CALL ISPITA(ACOZ)
      IF(INDFOR.EQ.1)
C     1READ(IULAZ,*) NGAUSX,NGAUSY,NGAUSZ,BETA,IALFA
     1READ(IULAZ,*) NGAUSX,NGAUSY,NGAUSZ,MSET,BETA,MSLOJ,IORT,IALFA
      IF(INDFOR.EQ.2)
C     1READ(ACOZ,1000) NGAUSX,NGAUSY,NGAUSZ,BETA,IALFA
     1READ(ACOZ,1000) NGAUSX,NGAUSY,NGAUSZ,MSET,BETA,MSLOJ,IORT,IALFA
      IF(IPODT.EQ.3) THEN
C          NGAUSX=4
C          NGAUSY=1
C          NGAUSZ=1
          IALFA=-1
          ENDIF
C      MSET=0
C      MSLOJ=0
      IF(IALFA.EQ.0) IALFA=2
C     IF(IALFA.GT.3) IALFA=2
      IF(MODORT(NMODM).EQ.1) THEN
      CALL ISPITA(ACOZ)
      IF(INDFOR.EQ.1)
     1READ(IULAZ,*) ((CPP(I,J),J=1,3),I=1,2)
      IF(INDFOR.EQ.2)
     1READ(ACOZ,1100) ((CPP(I,J),J=1,3),I=1,2)
      ENDIF
CE      CHECK FOR 9-POINTS INTEGRATION
       IF(NGAUSX.EQ.9)THEN
         NGAUSY=1
         NGAUSZ=1
       ENDIF
CE      CHECK FOR NEWTON-COTES INTEGRATION
        INCOTX=INCOT(NGAUSX)
        INCOTY=INCOT(NGAUSY)
        INCOTZ=INCOT(NGAUSZ)
      IF(MSLOJ.EQ.0 ) MSLOJ =10
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
      CALL WBROJK(KARTIC,0)
      IF(INCOTX.EQ.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2000) NGAUSX
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6000) NGAUSX
      ELSE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2006) NGAUSX
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6006) NGAUSX
      ENDIF
      IF(INCOTY.EQ.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2001) NGAUSY
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6001) NGAUSY
      ELSE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2007) NGAUSY
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6007) NGAUSY
      ENDIF
      IF(INCOTZ.EQ.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2002) NGAUSZ
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6002) NGAUSZ
      ELSE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2008) NGAUSZ
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6008) NGAUSZ
      ENDIF
      IF(MSET.GT.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2010) MSET,MSLOJ,BETA
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6010) MSET,MSLOJ,BETA
      ELSE
      IF(IORT.EQ.1) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2012) IORT
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6012) IORT
      ELSE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2011) BETA
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6011) BETA
      ENDIF
      ENDIF
      IF(ISRPS.EQ.0) WRITE(IZLAZ,2025) IALFA
      IF(ISRPS.EQ.1) WRITE(IZLAZ,6025) IALFA
      IF(MODORT(NMODM).EQ.1) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2020) ((CPP(I,J),J=1,3),I=1,2)
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6020) ((CPP(I,J),J=1,3),I=1,2)
      ENDIF
      ENDIF
C
      IBB0=1
      IF(MODORT(NMODM).EQ.1) THEN
      BETA=BETA*3.1415926536D0/180.D0
      IF(DABS(CPP(1,1)).LT.1.D-6.AND.DABS(CPP(1,2)).LT.1.D-6.AND.
     1   DABS(CPP(1,3)).LT.1.D-6) IBB0=0
      IF(DABS(CPP(2,1)).LT.1.D-6.AND.DABS(CPP(2,2)).LT.1.D-6.AND.
     1   DABS(CPP(2,3)).LT.1.D-6.AND.IBB0.EQ.1) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2040)
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6040)
      STOP 'PROGRAM STOP - PAK31 - UL3EGL'
      ENDIF
C
CS    FORMIRANJE MATRICE VEZE IZMEDJU PROJEKCIONIH PRAVACA I GLOB. OSA
C
      IF(IBB0.EQ.1) CALL TRANAL(CPP,TSG,0)
      ENDIF
C
CE    POINTERS IN INPUT STORAGE VECTOR  AU
CS    REPERI U VEKTORU AU ZA ULAZNE PODATKE
C
      NCVE=21
      IF(IPODT.EQ.1) NCVE=15
      IF(IPODT.EQ.2) NCVE=13
      IF(IPODT.EQ.3) NCVE=10
      LNNOD=1
      LMXAU=LNNOD+NE
      LNSLOJ=LMXAU
      LMATSL=LNSLOJ+MSET
      LBBET =LMATSL+MSET*MSLOJ
      CALL DELJIV(LBBET,2,INDL)
      IF(INDL.EQ.0) LBBET=LBBET+1
      LDSLOJ=LBBET+MSET*MSLOJ*IDVA
      LTHID =LDSLOJ+MSET*MSLOJ*IDVA
      IF(MSET.GT.0) THEN
         LBET0 =LTHID+NE*IDVA
         LTBTH =LBET0+NE*IDVA
      ELSE
         JJ=0
         IF(MODORT(NMODM).EQ.1) THEN
            JJ=36
            IF(IBB0.EQ.1.AND.IATYP.LE.1) JJ=0
            IF(IBB0.EQ.0.AND.IATYP.GT.1) JJ=0
         ENDIF
         LBET0 =LTHID+JJ*NE*IDVA
         LTBTH =LBET0
      ENDIF
      LTDTH =LTBTH
      IF(INDBTH.EQ.1) LTDTH=LTBTH+NE*IDVA
      LNMAT =LTDTH
      IF(INDDTH.EQ.1) LNMAT=LTDTH+NE*IDVA
      LIPGC=LNMAT+NE
      LISNA=LIPGC+NE
      LIPRC=LISNA+NE
      LNEL=LIPRC+NE
C
      NTOT=LMAX+LNEL-LNNOD+21*NE
      LCEL=LNEL
      IF(ICVEL.EQ.1) THEN
        LNEL=LCEL+NE
        NTOT=NTOT+NE
      ENDIF
      IF(NTOT.GT.MTOT) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2030) NTOT,MTOT
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6030) NTOT,MTOT
      STOP
      ENDIF
	LMXAU=LNEL+21*NE
C	CALL ICLEAR(A(LAU),LMXAU)
C
      LAU=LMAX
C
CE    CALL ROUTINES FOR INPUT DATA IN VECTOR AU
CS    POZIVANJE PROGRAMA ZA ULAZNE PODATKE U VEKTOR AU
C
      CALL UL3EK(A(LAU))
CE    SPACE USED FOR INTEGRATION OF ELEMENT VECTORS AND MATRICES
      MXAE = ND+(52*NCVE+ND*(ND+1)/2+30*6)*IDVA
      LMAX = LMAX + MXAE
      RETURN
C
C 1000 FORMAT(3I5,5X,F10.0,35X,I5)
 1000 FORMAT(4I5,F10.0,2I5,25X,I5)
 1100 FORMAT(6F10.0)
C-----------------------------------------------------------------------
 2000 FORMAT(
     611X,'BROJ GAUSOVIH TACAKA U PRAVCU OSE - R ......... NGAUSX =',I5/
     616X,'EQ.0; NGAUSX = 2'//)
 2001 FORMAT(
     611X,'BROJ GAUSOVIH TACAKA U PRAVCU OSE - S ......... NGAUSY =',I5/
     616X,'EQ.0; NGAUSY = 2'//)
 2002 FORMAT(
     611X,'BROJ GAUSOVIH TACAKA U PRAVCU OSE - T ......... NGAUSZ =',I5/
     616X,'EQ.0; NGAUSZ = 2'//)
 2006 FORMAT(
     611X,'BROJ NJUTN-KOTESOVIH TACAKA U PRAVCU OSE - R .. NGAUSX =',I5/
     6//)
 2007 FORMAT(
     611X,'BROJ NJUTN-KOTESOVIH TACAKA U PRAVCU OSE - S .. NGAUSY =',I5/
     6//)
 2008 FORMAT(
     611X,'BROJ NJUTN-KOTESOVIH TACAKA U PRAVCU OSE - T .. NGAUSZ =',I5/
     6//)
 2010 FORMAT(
     611X,'BROJ RAZLICITIH VISESLOJNIH SETOVA MATERIJALA ... MSET =',I5/
     616X,'GT.0; VISESLOJNA DEBELA LJUSKA'//
     611X,'MAKSIMALAN BROJ SLOJEVA   ...................... MSLOJ =',I5/
     6/ 
     611X,'UGAO VLAKANA U ODNOSU NA REFERENTNI PRAVAC . BETA =',1PD10.3)
 2011 FORMAT(//
     611X,'UGAO VLAKANA U ODNOSU NA REFERENTNI PRAVAC . BETA =',1PD10.3)
 2012 FORMAT(//
     611X,'UCITANI MATERIJALNI PRAVCI ZA SVAKI ELEMENT ...   IORT =',I5)
 2025 FORMAT(//
     611X,'METOD INKOMPATIBILNIH MODOVA ................... IALFA =',I5/
     616X,'EQ.-1; NE KORISTI SE'/
     616X,'EQ. 0; IALFA=2'/
     616X,'EQ. 1;  9 PARAMETARA - TAYLOR'/
     616X,'EQ. 2; 18 PARAMETARA'/
     616X,'EQ. 3; 12 PARAMETARA'/
     616X,'EQ. 6; 30 PARAMETARA')
 2020 FORMAT(//
     611X,'KOORDINATA TACKE PROJEKCIONOG PRAVCA 1 ..... CP1X =',1PD10.3/
     611X,'                                       ..... CP1Y =',1PD10.3/
     611X,'                                       ..... CP1Z =',1PD10.3/
     611X,'KOORDINATA TACKE ZA DEF. RAVNI 1 - 2   ..... CP2X =',1PD10.3/
     611X,'                                       ..... CP2Y =',1PD10.3/
     611X,'                                       ..... CP2Z =',1PD10.3)
 2030 FORMAT(///' NEDOVOLJNA DIMENZIJA U VEKTORU A ZA PODATKE O 3D ELEME
     1NTIMA'/' POTREBNA DIMENZIJA , LMAX=',I10/' RASPOLOZIVA DIMENZIJA,
     2NTOT =',I10)
 2040 FORMAT(///
     6' KOORDINATE TACKE ZA DEFINISANJE RAVNI 1 - 2  MORAJU BITI RAZLICI
     6TE OD NULE'/' PROGRAM STOP - PAK31 - UL3EGL')
C-----------------------------------------------------------------------
 6000 FORMAT(
     611X,'NUMBER OF GAUSS POINTS IN R-DIRECTION ......... NGAUSX =',I5/
     616X,'EQ.0; NGAUSX = 2'//)
 6001 FORMAT(
     611X,'NUMBER OF GAUSS POINTS IN S-DIRECTION ......... NGAUSY =',I5/
     616X,'EQ.0; NGAUSY = 2'//)
 6002 FORMAT(
     611X,'NUMBER OF GAUSS POINTS IN T-DIRECTION ......... NGAUSZ =',I5/
     616X,'EQ.0; NGAUSZ = 2')
 6006 FORMAT(
     611X,'NUMBER OF NEWTON-COTES POINTS IN R-DIRECTION .. NGAUSX =',I5/
     6//)
 6007 FORMAT(
     611X,'NUMBER OF NEWTON-COTES POINTS IN S-DIRECTION .. NGAUSY =',I5/
     6//)
 6008 FORMAT(
     611X,'NUMBER OF NEWTON-COTES POINTS IN T-DIRECTION .. NGAUSZ =',I5/
     6//)
 6010 FORMAT(
     611X,'NUMBER OF DIFFERENT MULTILAYERD MATERIAL SETS ... MSET =',I5/
     616X,'GT.0; MULTILAYERD THIK SHELL'//
     611X,'MAXIMUM NUMBER OF LAYERS  ...................... MSLOJ =',I5/
     6/
     611X,'ANGLE OF FIBER TO REFERENT DIRECTION ....... BETA =',1PD10.3)
 6011 FORMAT(//
     611X,'ANGLE OF FIBER TO REFERENT DIRECTION ....... BETA =',1PD10.3)
 6012 FORMAT(//
     611X,'MATERIAL DIRECTION ARE READED FROM FILE ......... IORT =',I5)
 6025 FORMAT(//
     611X,'METHOD OF INCOMPATIBLE MODES ................... IALFA =',I5/
     616X,'EQ.-1; NOT USED'/
     616X,'EQ. 0; IALFA=2'/
     616X,'EQ. 1;  9 PARAMETERS - TAYLOR'/
     616X,'EQ. 2; 18 PARAMETERS'/
     616X,'EQ. 3; 12 PARAMETERS'/
     616X,'EQ. 6; 30 PARAMETERS')
 6020 FORMAT(//
     611X,'COORDINATES FOR PROJECTED DIRECTION 1  ..... CP1X =',1PD10.3/
     611X,'                                       ..... CP1Y =',1PD10.3/
     611X,'                                       ..... CP1Z =',1PD10.3/
     611X,'COORDINATES FOR DEF. PLANE 1 - 2       ..... CP2X =',1PD10.3/
     611X,'                                       ..... CP2Y =',1PD10.3/
     611X,'                                       ..... CP2Z =',1PD10.3)
 6030 FORMAT(///' NOT ENOUGH SPACE IN WORKING VECTOR A FOR 3/D ELEMENTS'
     1/' REQUESTED DIMENSION , LMAX=',I10
     2/' AVAILABLE DIMENSION , MTOT=',I10)
 6040 FORMAT(///
     6' POINT COORDINATES FOR DEFINITION PLANE 1 - 2 MUST BE NON EQUAL 
     6ZERO'/' PROGRAM STOP - PAK31 - UL3EGL')
C-----------------------------------------------------------------------
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE UL3EK(AU)
      USE PLAST3D
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C ......................................................................
C .
CE.   P R O G R A M
CE.      TO FORM POINTERS AND READING INPUT DATA ABOUT 3/D ELEMENTS
CE.      IN VECTOR AU
CS.   P R O G R A M
CS.      ZA FORMIRANJE REPERA I U VEKTOR AU UCITAVANJE OPSTIH ULAZNIH 
CS.      PODATAKA O ELEMENTIMA: 3/D, PRIZMA, PIRAMIDA, TRIEDAR
C .
CE.    P O I N T E R S
CE.       LELC  - USED FOR FREE ELEMENT NUMERATION, IF (ICVEL.EQ.1)
CE.               SEE CARD /4/
CE.       LLMEL - NUMBERS OF EQUATIONS PER ELEMENTS
C .
CE.    V A R I A B L E S
CE.       IALFA - METHOD OF INCOMPATIBLE MODES, SEE CARD /13-3/(A)
CE.       IATYP - INDICATOR FOR TYPE OF ANALYSIS, SEE CARD /13/
CE.       NLD   - NUMBER OF STRESS COMPONENTS
C .
C ......................................................................
C
      include 'paka.inc'
      
      COMMON /IZOL4B/ NGS12,ND,MSLOJ,MXS,MSET,LNSLOJ,LMATSL,LDSLOJ,LBBET
      COMMON /ELEMAU/ MXAU,LAU,LLMEL,LNEL,LNMAT,LTHID,LIPGC,LIPRC,LISNA,
     1 LMXAU,LAPRS
      COMMON /SIMO2D/ LALFE,LHAEM,LHINV,LGEEK,IALFA
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /DUZINA/ LMAX,MTOT,LMAXM,LRAD,NRAD
      COMMON /REPERI/ LCORD,LID,LMAXA,LMHT
      COMMON /DUPLAP/ IDVA
      COMMON /restap/ irestp,lplas0,lstaz0
      COMMON /PLASTI/ LPLAST,LPLAS1,LSIGMA
      COMMON /POSTPR/ LNDTPR,LNDTGR,NBLPR,NBLGR,INDPR,INDGR
      COMMON /BTHDTH/ INDBTH,INDDTH,LTBTH,LTDTH
      COMMON /INCONF/ LINDBEL,LBIRTHC
      COMMON /CVOREL/ ICVEL,LCVEL,LELCV,NPA,NPI,LCEL,LELC,NMA,NMI
      COMMON /ORIENT/ CPP(3,3),XJJ(3,3),TSG(6,6),BETA,LBET0,IBB0
      COMMON /RESTAR/ TSTART,IREST
      COMMON /INTGRA/ INCOTX,INCOTY,INCOTZ
      COMMON /PROLAZ/ IVEZA
      COMMON /SRPSKI/ ISRPS
      COMMON /PODTIP/ IPODT
      COMMON /GAUSVR/ LTEMGT,LCORGT,ICORGT
      COMMON /CVSILE/ NSILA,LESILA
      COMMON /COEFSM/ COEF(3),ICOEF
      COMMON /IKOVAR/ INDKOV
      COMMON /CEPMAT/ INDCEP
      COMMON /LEVDES/ ILEDE,NLD,ICPM1
      COMMON /SUMELE/ ISUMEL,ISUMGR
      COMMON /MATERM/ LMODEL,LGUSM
      COMMON /OBNOVA/ IRUSI
      COMMON /CRACKS/ CONTE,SINTE,FK123(10,3),NODCR(10,14),NCRACK,LQST,
     1                LNERING,LMIE,LPSI,LQ,N100,IRING,NSEG,MAXRIN,MAXSEG
     1                ,MAXNOD,LXL,LYL,LZL,LSIF1,LXGG,LYGG,LZGG,LNNOD
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      DIMENSION AU(*)
      REAL AU
      COMMON /CDEBUG/ IDEBUG
C
      IF(IDEBUG.GT.0) PRINT *, ' UL3EK'
      LMAX8=LMAX8+1
      IF(IREST.EQ.1) THEN
        LMA8=LMAX8
        READ(IELEM,REC=LMAX8)
     1NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,ICORGT,LCEL,LELC,NMA,NMI,
     1MXAU,LNEL,LNMAT,LIPGC,LIPRC,LISNA,LTHID,LLMEL,IPODT,LNNOD,
     1ND,NGS12,MSLOJ,MXS,MSET,LNSLOJ,LMATSL,LDSLOJ,LBBET,NSILA,LESILA,
     1INCOTX,INCOTY,INCOTZ,LBET0,((CPP(J,I),J=1,3),I=1,3),
     1((TSG(J,I),J=1,6),I=1,6),BETA,IBB0,LALFE,LHAEM,LHINV,LGEEK,IALFA,
     1INDBTH,INDDTH,LTBTH,LTDTH,INDKOV,INDCEP,ILEDE,NLD,ICPM1,
     1COEF(3),ICOEF,LINDBEL,LBIRTHC
        CALL READDD(AU,MXAU/IDVA,IELEM,LMAX8,LDUZI)
        LMAX8=LMA8
      ENDIF
C
CE    CALL ROUTINE FOR INPUT DATA ABOUT 3/D ELEMENTS, SEE CARD /13-3/
CS    POZIVANJE PROGRAMA ZA ULAZNE PODATKE O 3D ELEMENTIMA
C
      NMA=0
      NMI=0
      CALL UL3EKC(AU(LNEL),AU(LNMAT),AU(LIPGC),AU(LISNA),AU(LIPRC),
     1            AU(LNSLOJ),AU(LMATSL),AU(LBBET),AU(LDSLOJ),
     1            AU(LTBTH),AU(LTDTH),AU(LCEL),NMA,NMI,ICVEL,AU(LNNOD))
C      CALL IWRR(AU(LNNOD),NE,'NCV0')
CE    WRITING DATA ABOUT ELEMENTS IN GRAPHIC OUTPUT FILES
      ISUMG=ISUMGR
      ISUME=ISUMEL
      IF(NBLGR.GE.0) CALL TGRAF3(AU(LNEL),AU(LCEL),ICVEL,AU(LNMAT))
C
      ISUMGR=ISUMG
      ISUMEL=ISUME
      IF(NBLGR.GE.0) CALL TGRAU3(AU(LNEL),AU(LCEL),ICVEL,AU(LNMAT),49,
     1                           A(LMODEL))
C
      IF(NBLGR.GE.0.AND.IREST.EQ.2)
     1CALL STAM31(AU(LNMAT),A(LAU),AU(LISNA),AU(LCEL),ICVEL)
CE    CONNECT NODE NUMBERS FOR FREE NODE NUMERATION
      IF(ICVEL.EQ.1) CALL VEZACE(AU(LNEL),A(LELCV),NE,NCVE)
C
      LLMEL=LNEL+NE*NCVE
      LELC=LLMEL
      IF(ICVEL.EQ.1) THEN
CE      NMA IS MAXIMUM AND NMI IS MINIMUM ELEMENT NUMBERS USED IN FREE
CE      ELEMENT NUMERATION
        LLMEL=LELC+NMA-NMI+1
        LMAX=LAU+LLMEL-1
        IF(LMAX.GT.MTOT) GO TO 4
CE      CLEAR INTEGERS IN WORKING VECTOR
        CALL ICLEAR(AU(LELC),NMA-NMI+1)
CE      CONNECT ELEMENT NUMBERS FOR FREE ELEMENT NUMERATION
        CALL VEZAEL(AU(LCEL),AU(LELC),NE,NMI)
C       TO CONECT NUMBERS NODES AND ELEMENTS FOR CRACKS IN FREE NUMERATION
C       OVO BI MOGLO DA SE PREMESTI KOD UCITAVANJA PRSLINA JER SE ELEMENTI NE KORISTE
        IF(NCRACK.GT.0.AND.NGE.EQ.1) CALL VEZACC(A(LELCV),AU(LELC),3)
      ENDIF
CE    NUMBER OF D.O.F PER 3D ELEMENT 
      ND=3*NCVE
CE    VECTORS WITH NUMBERS OF EQUATIONS FOR ALL 3D ELEMENTS
      LMXAU=LLMEL+NE*ND
C     TEZINSKE FUNKCIJE I ELEMENTI PO PRSTENOVIMA ZA EDI INTEGRAL
      IF(NCRACK.GT.0.AND.NGE.EQ.1) THEN
         CALL DELJIV(LMXAU,2,INDL)
         IF(INDL.EQ.0) LMXAU=LMXAU+1
         LPSI=LMXAU
         LMXAU=LPSI+NCRACK*MAXRIN*NE*MAXNOD*IDVA
C        LQST=LPSI+NCRACK*MAXRIN*NE*NCVE*IDVA
C        LMXAU=LQST+NCRACK*MAXSEG*MAXRIN*N100*NCVE*IDVA
         LMAX=LAU+LMXAU-1
         IF(LMAX.GT.MTOT) GO TO 4
         CALL CLEAR(AU(LPSI),NCRACK*MAXRIN*NE*MAXNOD)
C         CALL CLEAR(AU(LQST),NCRACK*MAXSEG*MAXRIN*N100*MAXNOD)
      ENDIF
C
      LALFE=LMXAU
      LHAEM=LMXAU
      LHINV=LMXAU
      LGEEK=LMXAU
      IF(NCVE.NE.8) IALFA=-1
CE    NUMBER OF INCOMPATIBLE DISPLACEMENTS
      LA=1
      IF(IALFA.EQ.1) LA=9
      IF(IALFA.EQ.2) LA=18
      IF(IALFA.EQ.3) LA=12
      IF(IALFA.EQ.6) LA=30
CE     CHECK POINTER VALUE AND SET TO ODD VALUE
      CALL DELJIV(LMXAU,2,INDL)
      IF(INDL.EQ.0) LMXAU=LMXAU+1
CE    POINTERS FOR VECTORS AND MATRICES USED FOR INCOMPATIBLE MODES
CE    (IALFA.GE.0), SEE CARD /13-3/(A)
      IF(IALFA.GE.0) THEN
         LALFE=LMXAU
C         LHAEM=LALFE+NE*LA*IDVA
         LHAEM=LALFE+NE*LA*IDVA*2
         LHINV=LHAEM+NE*LA*IDVA
         LGEEK=LHINV+NE*LA*LA*IDVA
         LMXAU=LGEEK+NE*LA*ND*IDVA
      ENDIF
CE    POINTER FOR ELEMENT NODAL FORCES
      LESILA=LMXAU
      LMXAU=LESILA+NSILA*ND*IDVA
CE    pointer for initial configuration for birth elements
      LBIRTHC=LMXAU
      LINDBEL=LMXAU
      IF(INDBTH.EQ.1) THEN
         LINDBEL=LBIRTHC+NE*NCVE*3*IDVA
         LMXAU=LINDBEL+NE
      ENDIF
C
CE    LENGTH OF VECTOR AU(*)
      MXAU = LMXAU - 1
      CALL DELJIV(MXAU,2,INDL)
      IF(INDL.EQ.1) MXAU=MXAU+1
      LMAX=LAU+MXAU
         memau=(4*MXAU)/1000000
            write(*,*) ' AU matrix memory MB=',memau 
            write(3,*) ' AU matrix memory MB=',memau 
    4 IF(LMAX.GT.MTOT) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2005) LMAX,MTOT
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6005) LMAX,MTOT
      STOP
      ENDIF
C
CE    FORM VECTOR LM AND HEIGHT OF COLUMNS IN STIFFNESS MATRIX
CS    FORMIRANJE VEKTORA LM I VISINA STUBOVA
C
      IF((IALFA.GE.0.OR.NSILA.GT.0).AND.IREST.NE.1) 
     1CALL CLEAR(AU(LALFE),(LMXAU-LALFE)/IDVA)
      CALL ICLEAR(AU(LLMEL),NE*ND)
      CALL LM3MHT(A(LID),AU(LNEL),AU(LLMEL),ND)
C
      NGS12=NGAUSX*NGAUSY*NGAUSZ
      IF(IPODT.EQ.3) NGS12=4
      IF(MODORT(NMODM).EQ.1) THEN
CS       FORMIRANJE VEZE IZMEDJU ELEMENTA I GLOBALNIH OSA
         IF((IBB0.EQ.1.AND.IATYP.GT.1).OR.
     1      (IBB0.EQ.0.AND.IATYP.LE.1))
     1      CALL JEDVEK(AU(LNEL),AU(LTHID)) 
      ENDIF
C
CS    ZAPISIVANJE SKALARA NA DIREKT ACCES FILE 
CE    WRITE SCALARS TO A DIRECT ACCESS FILE
C
      IF(LDUZI.LE.100) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2000) LDUZI
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6000) LDUZI
      STOP
      ENDIF
      WRITE(IELEM,REC=LMAX8)
     1NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,ICORGT,LCEL,LELC,NMA,NMI,
     1MXAU,LNEL,LNMAT,LIPGC,LIPRC,LISNA,LTHID,LLMEL,IPODT,LNNOD,
     1ND,NGS12,MSLOJ,MXS,MSET,LNSLOJ,LMATSL,LDSLOJ,LBBET,NSILA,LESILA,
     1INCOTX,INCOTY,INCOTZ,LBET0,((CPP(J,I),J=1,3),I=1,3),
     1((TSG(J,I),J=1,6),I=1,6),BETA,IBB0,LALFE,LHAEM,LHINV,LGEEK,IALFA,
     1INDBTH,INDDTH,LTBTH,LTDTH,INDKOV,INDCEP,ILEDE,NLD,ICPM1,
     1COEF(3),ICOEF,LINDBEL,LBIRTHC
      CALL WRITDD(AU,MXAU/IDVA,IELEM,LMAX8,LDUZI)
      CALL DELJIV(LMAX,2,INDL)
      IF(INDL.EQ.0) LMAX=LMAX+1
C
C     NAJKRACE RASTOJANJE IZMEDJU CVOROVA
      CALL NAJKRA(AU(LNEL),AU(LNNOD),AU(LCEL),A(LCVEL),ICVEL,
     1            A(LCORD),NP,NE,IZLAZ)
C
CS    PLASTICNOST
CE    PLASTICITY
C
      LPLAST=LMAX
      LPLAS1=LMAX
      lplas0=lmax
      LSIGMA=LMAX
      IF(IATYP.EQ.0) GO TO 10
      IF(NMODM.LE.4) GO TO 10
CE    MEMORY ALLOCATION FOR MATERIAL MODELS (NMODM.GE.5),SEE /13/, /11/
CE    TOTAL SPACE USED FOR ALL INTEGRATION POINTS
      NPROS=NE*NGS12*MODPRO( NMODM )*IDVA
CE    POINTERS FOR INTEGRATION POINT DATA FOR TIME (T) AND (T+DT)
!      LPLAS1=LPLAST+NPROS
!      LMAX=LPLAS1+NPROS
            mempl=(8*NPROS)/1000000
            write(3,*) ' 2*PLAST memory MB=',mempl 
            write(*,*) ' 2*PLAST memory MB=',mempl 
      ALLOCATE (PLAST(NPROS/IDVA), STAT = iAllocateStatus)
      IF (iAllocateStatus /= 0) write(3,*)'PLAST* Not enough memory ***'
      IF (iAllocateStatus /= 0) STOP '*** Not enough memory ***'
      ALLOCATE (PLAS1(NPROS/IDVA), STAT = iAllocateStatus)
      IF (iAllocateStatus /= 0) write(3,*)'PLAS1* Not enough memory ***'
      IF (iAllocateStatus /= 0) STOP '*** Not enough memory ***'
      idum=2
      if(irusi.eq.1) then
         idum=3
!         LPLAS0=LMAX
!         LMAX=LPLAS0+NPROS
            mempl0=(8*NPROS)/1000000
            write(3,*) ' PLAST0 memory MB=',mempl0 
            write(*,*) ' PLAST0 memory MB=',mempl0 
         ALLOCATE (PLAS0(NPROS/IDVA), STAT = iAllocateStatus)
         IF (iAllocateStatus /= 0) write(3,*)'PLAS0* Not enough memory*'
         IF (iAllocateStatus /= 0) STOP '*** Not enough memory ***'
      endif
      IF(LMAX.GT.MTOT) CALL ERROR(1)
      IF(IREST.NE.1) THEN
!         CALL CLEAR(A(LPLAST),NPROS*idum/IDVA)
         CALL CLEAR(PLAST,NPROS/IDVA)
         CALL CLEAR(PLAS1,NPROS/IDVA)
         if(irusi.eq.1)CALL CLEAR(PLAS0,NPROS/IDVA)
!         CALL WRITDD(A(LPLAST),NPROS/IDVA,IELEM,LMAX8,LDUZI)
!         CALL WRITDD(A(LPLAS1),NPROS/IDVA,IELEM,LMAX8,LDUZI)
         CALL WRITDD(PLAST,NPROS/IDVA,IELEM,LMAX8,LDUZI)
         CALL WRITDD(PLAS1,NPROS/IDVA,IELEM,LMAX8,LDUZI)
         if(irusi.eq.1) 
     1   CALL WRITDD(PLAS0,NPROS/IDVA,IELEM,LMAX8,LDUZI)
!     1   CALL WRITDD(A(LPLAS0),NPROS/IDVA,IELEM,LMAX8,LDUZI)
      ELSE
!         CALL READDD(A(LPLAST),NPROS/IDVA,IELEM,LMAX8,LDUZI)
!         CALL READDD(A(LPLAS1),NPROS/IDVA,IELEM,LMAX8,LDUZI)
         CALL READDD(PLAST,NPROS/IDVA,IELEM,LMAX8,LDUZI)
         CALL READDD(PLAS1,NPROS/IDVA,IELEM,LMAX8,LDUZI)
         if(irusi.eq.1) 
     1   CALL READDD(PLAS0,NPROS/IDVA,IELEM,LMAX8,LDUZI)
!     1   CALL READDD(A(LPLAS0),NPROS/IDVA,IELEM,LMAX8,LDUZI)
      ENDIF
      DEALLOCATE (PLAST)
      DEALLOCATE (PLAS1)
      if(irusi.eq.1) DEALLOCATE (PLAS0)
C
      IF(IATYP.GE.4) GO TO 10
      NPROS=0
      LSIGMA=LMAX
      IF(ITERME.EQ.1) GO TO 20
      IF(ICORGT.EQ.1) GO TO 30
      RETURN
C
CE    POINTER FOR STRESSES AT INTEGRATION POINTS FOR ALL ELEMENTS,
CE    USED FOR LINEAR ANALYSIS
   10 LSIGMA=LMAX
      NPROS=NE*NGS12*NLD*MXS*IDVA
      IF(NMODM.LE.4) NPROS=NPROS*2
      LMAX=LSIGMA+NPROS
CE    POINTER FOR COORDINATES IN TIME (T) USED FOR LARGE STRAIN ANALYSIS
      LCOR0=LMAX
      IF(IATYP.GE.4) THEN
         NPRO1=NE*NCVE*3*IDVA
         LMAX=LCOR0+NPRO1
         NPROS=NPROS+NPRO1
      ENDIF
CE    POINTER FOR TEMPERATURES AT INTEGRATION POINTS
   20 LTEMGT=LMAX
      IF(ITERME.EQ.1) THEN
         NPRO1=NE*NGS12*MXS*IDVA
         LMAX=LTEMGT+NPRO1
         NPROS=NPROS+NPRO1
      ENDIF
CE    POINTER FOR INTEGRATION POINTS COORDINATES
   30 LCORGT=LMAX
      IF(ICORGT.EQ.1) THEN
         NPRO1=NE*NGS12*3*MXS*IDVA
         LMAX=LCORGT+NPRO1
         NPROS=NPROS+NPRO1
      ENDIF
      IF(LMAX.GT.MTOT) CALL ERROR(1)
      IF(IREST.NE.1) THEN
         CALL CLEAR(A(LSIGMA),NPROS/IDVA)
C
CS       ZADAVANJE POCETNE VREDNOSTI ZA - B
CE       INITIAL VALUE FOR - B 
C
         IF(IATYP.GE.4)
     1   CALL ZADA3B(A(LSIGMA),NE,NGS12,MXS,NLD)
         CALL WRITDD(A(LSIGMA),NPROS/IDVA,IELEM,LMAX8,LDUZI)
      ELSE
         CALL READDD(A(LSIGMA),NPROS/IDVA,IELEM,LMAX8,LDUZI)
      ENDIF
      RETURN
C-----------------------------------------------------------------------
 2000 FORMAT(//' DUZINA STAZE RECL=LDUZI=',I5,' ZA FILE=IELEM, ACCESS=
     1DIRECT, MORA BITI VECA OD    100'//' PROGRAM STOP'//)
 2005 FORMAT(///' NEDOVOLJNA DIMENZIJA U VEKTORU A ZA PODATKE O 3D ELEME
     1NTIMA'/' POTREBNA DIMENZIJA , LMAX=',I10/' RASPOLOZIVA DIMENZIJA,
     2NTOT =',I10)
C-----------------------------------------------------------------------
 6000 FORMAT(//' RECORD LENGTH RECL=LDUZI=',I5,'  FILE=IELEM, ACCESS=
     1DIRECT, MUST BE  .GT. THEN  100'//' PROGRAM STOP'//)
 6005 FORMAT(///' NOT ENOUGH SPACE IN WORKING VECTOR A FOR 3/D ELEMENTS'
     1/' REQUESTED DIMENSION , LMAX=',I10
     2/' AVAILABLE DIMENSION , MTOT=',I10)
C-----------------------------------------------------------------------
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE UL3EKC(NEL,MATV,IPGCV,ISNAP,IPRCV,NSLOJ,MATSL,
     1                  BBET,DSLOJ,TBTH,TDTH,MCVEL,NMA,NMI,ICVEL,NNOD)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C ......................................................................
C .
CE.   P R O G R A M
CE.      TO READING INPUT DATA ABOUT 3/D ELEMENTS - FREE NUMERATION
CS.   P R O G R A M
CS.      ZA UCITAVANJE ULAZNIH PODATAKA O ELEMENTIMA: 3/D, PRIZMA,
CS.      PIRAMIDA, TRIEDAR - SLOBODNA NUMERACIJA
C .
C ......................................................................
C
      CHARACTER*250 ACOZ
      CHARACTER*4  CH
      include 'paka.inc'
      
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /IZOL4B/ NGS12,ND,MSLOJ,MXS,MSET,LNSLOJ,LMATSL,LDSLOJ,LBBET
      COMMON /BTHDTH/ INDBTH,INDDTH,LTBTH,LTDTH
      COMMON /GAUSVR/ LTEMGT,LCORGT,ICORGT
      COMMON /SRPSKI/ ISRPS
      COMMON /PODTIP/ IPODT
      COMMON /CVSILE/ NSILA,LESILA
      COMMON /RESTAR/ TSTART,IREST
      COMMON /STAPRO/ THIDP(100),NPROPR(100)
      DIMENSION NPODT(21)
      DIMENSION NEL(NE,*),MATV(*),IPGCV(*),ISNAP(*),IPRCV(*),
     1          NSLOJ(*),MATSL(MSLOJ,*),BBET(MSLOJ,*),DSLOJ(MSLOJ,*),
     1          TBTH(*),TDTH(*),MCVEL(*),NNOD(*)
      COMMON /CDEBUG/ IDEBUG
C
      IF(IDEBUG.GT.0) PRINT *, ' UL3EKC'
      if(irest.ne.1) CALL ICLEAR(Nel,ne*21)
      CALL ICLEAR(NPROPR,100)
      IF(ISRPS.EQ.0) CH='BROJ'
      IF(ISRPS.EQ.1) CH='NUMB'
      MXS=1
      ICORGT=0
C
CS     P  O  D  A  C  I      O      S  L  O  J  E  V  I  M  A
CE     D  A  T  A      A  B  O  U  T      L  A  Y  E  R  S
C
      IF(MSET.GT.0) THEN
        CH='SET '
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2500)
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6500)
        DO 2 I=1,MSET
          CALL ISPITA(ACOZ)
          IF(INDFOR.EQ.1)
     1    READ(IULAZ,*) NSLOJ(I)
          IF(INDFOR.EQ.2)
     1    READ(ACOZ,1000) NSLOJ(I)
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2530) I,NSLOJ(I)
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6530) I,NSLOJ(I)
          IF(NSLOJ(I).LT.1.OR.NSLOJ(I).GT.MSLOJ)THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2505)
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6505)
            STOP 'STOP - UEL4B'
          ENDIF
      IF(NSLOJ(I).GT.MXS) MXS=NSLOJ(I) 
            TTT=0.D0
            DO 1 J=1,NSLOJ(I)
              CALL ISPITA(ACOZ)
              IF(INDFOR.EQ.1)
     1        READ(IULAZ,*)   MATSL(J,I),DSLOJ(J,I),BBET(J,I)
              IF(INDFOR.EQ.2)
     1        READ(ACOZ,1515) MATSL(J,I),DSLOJ(J,I),BBET(J,I)
      IF(ISRPS.EQ.0.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,2540) J,MATSL(J,I),DSLOJ(J,I),BBET(J,I)
      IF(ISRPS.EQ.1.AND.(NULAZ.EQ.1.OR.NULAZ.EQ.3))
     1WRITE(IZLAZ,6540) J,MATSL(J,I),DSLOJ(J,I),BBET(J,I)
              BBET(J,I)=BBET(J,I)*3.1415926536D0/180.D0
            TTT=TTT+DSLOJ(J,I)
    1       CONTINUE
CS....  PROVERA ZA DEBLJINE
      IF(DABS(TTT-1.D0).LT.1.D-6.OR.NMODM.EQ.25) GO TO 2
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2550) TTT
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6550) TTT
        STOP'STOP - UEL4B'
    2   CONTINUE      
      ENDIF
C
CS    P  O  D  A  C  I      O      E  L  E  M  E  N  T  I  M  A
CE    D  A  T  A      A  B  O  U  T      E  L  E  M  E  N  T  S
C
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
      IF(IPODT.EQ.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2000) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6000) NGE,CH
      ENDIF
      IF(IPODT.EQ.1) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2100) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6100) NGE,CH
      ENDIF
      IF(IPODT.EQ.2) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2200) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6200) NGE,CH
      ENDIF
      IF(IPODT.EQ.3) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2300) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6300) NGE,CH
      ENDIF
      ENDIF
	ncveul=21
	if(irest.eq.1) ncveul=ncve
      IT1=8
      IT2=21
      IF(IPODT.EQ.1) THEN
         IT1=6
         IT2=15
      ENDIF
      IF(IPODT.EQ.2) THEN
         IT1=5
         IT2=13
      ENDIF
      IF(IPODT.EQ.3) THEN
         IT1=4
         IT2=10
      ENDIF
      NMATS=  1
      IPRCOS=-1
      IPGSS= -1
      ISNAA= -1
      I = 0
      NAUT=0
    5 I = I + 1
      CALL ISPITA(ACOZ)
      IF(I.EQ.1) KARTI=KARTIC
      IF(INDFOR.EQ.1)
     1READ(IULAZ,*) NN,NMAT,IPRCO,ISNA,IPGS,KORC,BTH,DTH
      IF(INDFOR.EQ.2.and.ind56.eq.0)
     1READ(ACOZ,1010) NN,NMAT,IPRCO,ISNA,IPGS,KORC,BTH,DTH
      IF(INDFOR.EQ.2.and.ind56.eq.1)
     1READ(ACOZ,4010) NN,NMAT,IPRCO,ISNA,IPGS,KORC,BTH,DTH
      IF(NPROPR(NMAT).EQ.0) THEN
         IF(NMAT.GT.100) STOP 'NMAT.GT.100'
         NPROPR(NMAT)=NMAT
      ENDIF
      IF(IPRCO.EQ.1) ICORGT=1
      IF(ICVEL.EQ.1) THEN
         MCVEL(I)=NN
         NI=NN
         IF(I.EQ.1) THEN
            NMA=NN
            NMI=NN
         ELSE
            IF(NMA.LT.NN) NMA=NN
            IF(NMI.GT.NN) NMI=NN
         ENDIF
         NN=I
      ENDIF
      CALL ISPITA(ACOZ)
      IF(INDFOR.EQ.1)
     1READ(IULAZ,*) (NEL(NN,J),J=1,IT1)
      IF(INDFOR.EQ.2.and.ind56.eq.0)
     1READ(ACOZ,1000) (NEL(NN,J),J=1,IT1)
      IF(INDFOR.EQ.2.and.ind56.eq.1)
     1READ(ACOZ,4000) (NEL(NN,J),J=1,IT1)
      CALL ISPITA(ACOZ)
      IF(INDFOR.EQ.1)
     1READ(IULAZ,*) (NEL(NN,J),J=IT1+1,NCVE)
      IF(INDFOR.EQ.2.and.ind56.eq.0)
     1READ(ACOZ,1000) (NEL(NN,J),J=IT1+1,NCVE)
      IF(INDFOR.EQ.2.and.ind56.eq.1)
     1READ(ACOZ,4000) (NEL(NN,J),J=IT1+1,NCVE)
      IF(NMAT.EQ.0) NMAT=NMATS
      NMATS=NMAT
      MATV(NN)= NMAT
      IF(IPRCO.EQ.0) IPRCO=IPRCOS
      IPRCOS=IPRCO
      IF(IPRCO.LT.0) IPRCO = 0
      IPRCV(NN)=IPRCO
      IF(ISNA.EQ.0) ISNA=ISNAA
      ISNAA=ISNA
      IF(ISNA.LT.0) ISNA = 0
      ISNAP(NN)=ISNA
      IF(IPGS.EQ.0) IPGS=IPGSS
      IPGSS=IPGS
      IF(IPGS.LT.0) IPGS = 0
      IPGCV(NN)=IPGS
      IF(INDBTH.EQ.1) TBTH(NN)=BTH
      IF(INDDTH.EQ.1) TDTH(NN)=DTH
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
         IF(ICVEL.EQ.1) IN=MCVEL(NN)
         IF(ICVEL.EQ.0) IN=NN
         IF(IPODT.EQ.0) WRITE(IZLAZ,5000) IN,(NEL(NN,J),J=1,IT1),NMAT,
     1                  IPRCO,ISNA,IPGS,KORC
         IF(IPODT.EQ.0.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5011) (NEL(NN,J),J=IT1+1,NCVE)
         IF(IPODT.EQ.1) WRITE(IZLAZ,5001) IN,(NEL(NN,J),J=1,IT1),NMAT,
     1                  IPRCO,ISNA,IPGS,KORC
         IF(IPODT.EQ.1.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5013) (NEL(NN,J),J=IT1+1,NCVE)
         IF(IPODT.EQ.2) WRITE(IZLAZ,5002) IN,(NEL(NN,J),J=1,IT1),NMAT,
     1                  IPRCO,ISNA,IPGS,KORC
         IF(IPODT.EQ.2.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5013) (NEL(NN,J),J=IT1+1,NCVE)
         IF(IPODT.EQ.3) WRITE(IZLAZ,5003) IN,(NEL(NN,J),J=1,IT1),NMAT,
     1                  IPRCO,ISNA,IPGS,KORC
         IF(IPODT.EQ.3.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5013) (NEL(NN,J),J=IT1+1,NCVE)
         IF(INDBTH.EQ.1) THEN
         IF(DABS(TBTH(NN)).GT.1.0D-10) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2040) TBTH(NN)
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6040) TBTH(NN)
         ENDIF
         ENDIF
         IF(INDDTH.EQ.1) THEN 
         IF(DABS(TDTH(NN)).GT.1.0D-10) THEN 
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2050) TDTH(NN)
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6050) TDTH(NN)
         ENDIF
         ENDIF
      ENDIF
      IF(NAUT.GT.0) GO TO 30
      IF(KORC.NE.0) GO TO 20
      IF(I.EQ.NE) GO TO 50
      GO TO 5
C
   20 NAUT=1
      IF(ICVEL.EQ.1) N1=NI
      IF(ICVEL.EQ.0) NN1=NN
      KORA=KORC
      GO TO 5
C
CE    AUTOMATIC GENERATED DATA BETWEEN NODES N1 AND N2
CS    AUTOMATSKO GENERISANJE PODATAKA IZMEDJU CVOROVA N1 I N2
C
   30 NN2=NN
      IF(ICVEL.EQ.1) THEN
         NN1=NN-1
         N2=NI
      ENDIF
      N11=NEL(NN1,1)
      N22=NEL(NN2,1)
      N12=N22-N11
      CALL DELJIV(N12,KORA,INDD)
      IF(INDD.EQ.1) GO TO 100
      DO 40 NC=2,IT1
         N11=NEL(NN1,NC)
         N22=NEL(NN2,NC)
         N21=N22-N11
         IF(N12.NE.N21) GO TO 100
   40 CONTINUE
      IF(NCVE.GT.IT1) THEN
         DO 45 NC=IT1+1,NCVE
            N11=NEL(NN1,NC)
            N22=NEL(NN2,NC)
            IF(N11.EQ.0.AND.N22.EQ.0) GO TO 45
            N21=N22-N11
            IF(N12.NE.N21) GO TO 100
   45    CONTINUE
      ENDIF
      IF(ICVEL.EQ.1) NNN=N2-N1-1
      IF(ICVEL.EQ.0) NNN=NN2-NN1-1
      NGG=N12/KORA-1
      IF(NNN.NE.NGG) THEN
         IF(ICVEL.EQ.1) THEN
            NN1=N1
            NN2=N2
         ENDIF
         GO TO 150
      ENDIF
      IAUT=N12/KORA-1
      IF(ICVEL.EQ.1) THEN
         NM=NN+IAUT
         MCVEL(NM)=MCVEL(NN)
         MATV(NM) = MATV(NN)
         IPRCV(NM)=IPRCV(NN)
         ISNAP(NM)=ISNAP(NN)
         IPGCV(NM)=IPGCV(NN)
         IF(INDBTH.EQ.1) TBTH(NM) = TBTH(NN)
         IF(INDDTH.EQ.1) TDTH(NM) = TDTH(NN)
         DO 32 II=1,NCVE
            NEL(NM,II)=NEL(NN,II)
   32    CONTINUE
      ENDIF
      DO 34 J=1,IAUT
         JJ=NN1+J
         IF(ICVEL.EQ.1) THEN
            N1=N1+1
            MCVEL(JJ)=N1
         ENDIF
         MATV(JJ) = MATV(NN1)
         IPRCV(JJ)=IPRCV(NN1)
         ISNAP(JJ)=ISNAP(NN1)
         IPGCV(JJ)=IPGCV(NN1)
         IF(INDBTH.EQ.1) TBTH(JJ) = TBTH(NN1)
         IF(INDDTH.EQ.1) TDTH(JJ) = TDTH(NN1)
         DO 35 II=1,NCVE
            NODP=NEL(JJ-1,II)
            NEL(JJ,II)=NODP+KORA
            IF(NODP.EQ.0) NEL(JJ,II) = 0
   35    CONTINUE
   34 CONTINUE
      IF(ICVEL.EQ.1) I=NM
      IF(ICVEL.EQ.0) I=I+IAUT
      IF(I.EQ.NE) GO TO 50
      NAUT=0
      IF(KORC.EQ.0) GO TO 5
      KORA=KORC
      NAUT=1
      IF(ICVEL.EQ.1) N1=N2
      IF(ICVEL.EQ.0) NN1=NN2
      GO TO 5
C
CE    MAXIMUM NUMBER NODES OF 3/D ELEMENTS
CS    ODREDJIVANJE MAKSIMALNOG BROJA CVOROVA NA 3/D ELEMENTIMA
C
   50 IF(IREST.EQ.1) GO TO 61
      NCVE=IT1
      DO 60 I=1,NE
         NNOD(I)=IT1
      DO 60 J=IT1+1,IT2
         IJ=NEL(I,J)
         IF(IJ.GT.0.AND.J.GT.NCVE) NCVE=J
         IF(IJ.GT.0.AND.J.GT.NNOD(I)) NNOD(I)=J
   60 CONTINUE
C
   61 NSILA=0
      DO 65 I=1,NE
         IF(IPGCV(I).EQ.1) THEN
            NSILA=NSILA+1
            IPGCV(I)=NSILA
         ELSE
            IPGCV(I)=0
         ENDIF
   65 CONTINUE
C
CE    PRINT INPUT AND GENERATED DATA ABOUT NODES ELEMENTS
CS    STAMPANJE UCITANIH I GENERISANIH PODATAKA O CVOROVIMA ELEMENATA
C
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
      CALL WBROJK(KARTI,0)
      IF(IPODT.EQ.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2140) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6140) NGE,CH
      ENDIF
      IF(IPODT.EQ.1) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2240) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6240) NGE,CH
      ENDIF
      IF(IPODT.EQ.2) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2340) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6340) NGE,CH
      ENDIF
      IF(IPODT.EQ.3) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2440) NGE,CH
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6440) NGE,CH
      ENDIF
         DO 70 I=1,NE
            IF(ICVEL.EQ.1) IN=MCVEL(I)
            IF(ICVEL.EQ.0) IN=I
            IF(IPODT.EQ.0) WRITE(IZLAZ,5004) IN,(NEL(I,J),J=1,IT1),
     1                     MATV(I),IPRCV(I),ISNAP(I),IPGCV(I)
            IF(IPODT.EQ.0.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5011) (NEL(I,J),J=IT1+1,NCVE)
            IF(IPODT.EQ.1) WRITE(IZLAZ,5005) IN,(NEL(I,J),J=1,IT1),
     1                     MATV(I),IPRCV(I),ISNAP(I),IPGCV(I)
            IF(IPODT.EQ.1.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5013) (NEL(I,J),J=IT1+1,NCVE)
            IF(IPODT.EQ.2) WRITE(IZLAZ,5006) IN,(NEL(I,J),J=1,IT1),
     1                     MATV(I),IPRCV(I),ISNAP(I),IPGCV(I)
            IF(IPODT.EQ.2.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5013) (NEL(I,J),J=IT1+1,NCVE)
            IF(IPODT.EQ.3) WRITE(IZLAZ,5007) IN,(NEL(I,J),J=1,IT1),
     1                     MATV(I),IPRCV(I),ISNAP(I),IPGCV(I)
            IF(IPODT.EQ.3.AND.NCVE.GT.IT1)
     +                   WRITE(IZLAZ,5013) (NEL(I,J),J=IT1+1,NCVE)
         IF(INDBTH.EQ.1) THEN
         IF(DABS(TBTH(I)).GT.1.0D-10) THEN
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2040) TBTH(I)
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6040) TBTH(I)
         ENDIF
         ENDIF
         IF(INDDTH.EQ.1) THEN 
         IF(DABS(TDTH(I)).GT.1.0D-10) THEN 
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2050) TDTH(I)
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6050) TDTH(I)
         ENDIF
         ENDIF
   70    CONTINUE
      ENDIF
C
      IF(IPODT.EQ.1) THEN
         NCVZ=5
         IF(NCVE.EQ.6) NCVZ=2
         NCVE=NCVE+NCVZ
         DO 170 I=1,NE
            DO 171 J=4,IT2
               NPODT(J)=NEL(I,J)
  171       CONTINUE
            NEL(I,4)=NEL(I,1)
            NEL(I,8)=NPODT(4)
            DO 172 J=1,3
               NEL(I,J+4)=NPODT(J+3)
  172       CONTINUE
            IF(NCVE.GT.8) THEN
               NEL(I,12)=NEL(I,1)
               NEL(I,16)=NEL(I,8)
               NEL(I,20)=NPODT(13)
               DO 173 J=1,3
                  NEL(I,J+8)=NPODT(J+6)
                  NEL(I,J+12)=NPODT(J+9)
                  NEL(I,J+16)=NPODT(J+12)
  173          CONTINUE
            ENDIF
  170    CONTINUE
      ENDIF
      IF(IPODT.EQ.2) THEN
         NCVZ=7
         IF(NCVE.EQ.5) NCVZ=3
         NCVE=NCVE+NCVZ
         DO 180 I=1,NE
            DO 181 J=1,IT2
               NPODT(J)=NEL(I,J)
  181       CONTINUE
            DO 182 J=1,4
               NEL(I,J)=NPODT(1)
               NEL(I,J+4)=NPODT(J+1)
  182       CONTINUE
            IF(NCVE.GT.8) THEN
               DO 183 J=1,4
                  NEL(I,J+8)=NPODT(1)
                  NEL(I,J+12)=NPODT(J+5)
                  NEL(I,J+16)=NPODT(J+9)
  183          CONTINUE
            ENDIF
  180    CONTINUE
      ENDIF
C TETREIN ZA PREPIS U DEGENERISANI
      ITETRA=1
      IF(ITETRA.EQ.0) THEN
      IF(IPODT.EQ.3) THEN
         NCVZ=10
         IF(NCVE.EQ.4) NCVZ=4
         NCVE=NCVE+NCVZ
         DO 190 I=1,NE
            DO 191 J=1,IT2
               NPODT(J)=NEL(I,J)
  191       CONTINUE
            NEL(I,8)=NPODT(2)
            DO 192 J=1,3
               NEL(I,J+1)=NPODT(1)
               NEL(I,J+4)=NPODT(J+1)
  192       CONTINUE
            IF(NCVE.GT.8) THEN
               NEL(I,12)=NEL(I,1)
               NEL(I,16)=NEL(I,8)
               NEL(I,20)=NPODT(8)
               DO 193 J=1,3
                  NEL(I,J+8)=NPODT(1)
                  NEL(I,J+12)=NPODT(J+4)
                  NEL(I,J+16)=NPODT(J+7)
  193          CONTINUE
            ENDIF
  190    CONTINUE
      ENDIF
C     SVI ELEMENTI SU PROSIRENI NA KLASICAN 3D
      IT1=8
      IT2=21
	if(irest.eq.1) it2=ncveul
      IPODT=0
      NCVE=IT1
      DO 66 I=1,NE
         NNOD(I)=IT1
      DO 66 J=IT1+1,IT2
         IJ=NEL(I,J)
         IF(IJ.GT.0.AND.J.GT.NCVE) NCVE=J
         IF(IJ.GT.0.AND.J.GT.NNOD(I)) NNOD(I)=J
   66 CONTINUE
      ENDIF
C TETREOUT
      RETURN
C
  150 CONTINUE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2110) NN1,NN2,NGG
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6110) NN1,NN2,NGG
      STOP
C
  100 CONTINUE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2120) N22,N11,KORA
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6120) N22,N11,KORA
      STOP
C
 1000 FORMAT(14I5)
 4000 FORMAT(13I10)
 1010 FORMAT(6I5,10X,2F10.0)
 4010 FORMAT(I10,I5,4I5,10X,2F10.0)
 1515 FORMAT(I5,2F10.0)
 5000 FORMAT(I10,1X,8I10,1X,5I6)
 5001 FORMAT(I10,2X,6I10,4X,5I6)
 5002 FORMAT(I10,2X,5I10,10X,5I6)
 5003 FORMAT(I10,2X,4I10,16X,5I6)
 5011 FORMAT(6X,13I10)
 5004 FORMAT(I10,1X,8I10,1X,4I6)
 5005 FORMAT(I10,2X,6I10,4X,4I6)
 5006 FORMAT(I10,2X,5I10,10X,4I6)
 5007 FORMAT(I10,2X,4I10,16X,4I6)
 5013 FORMAT(7X,9I10)
C-----------------------------------------------------------------------
 2000 FORMAT(///' UCITANI PODACI O IZOPARAMETARSKIM 3/D ELEMENTIMA GRUPE
     1 ELEMENATA',I6/1X,70('-')///
     3' ELEME  CVO1 CVO2 CVO3 CVO4 CVO5 CVO6 CVO7 CVO8  MATER KOORD NAPO
     1N NAPON KORAK'/'  BROJ',44X,A4,' STAMP STAMP CVORA GENER'/7X,    ' 
     1CVO9 CV10 CV11 CV12 CV13 CV14 CV15 CV16 CV17 CV18 CV19 CV20 CV21')
 2100 FORMAT(///' UCITANI PODACI O ELEMENTIMA TROSTRANIM PRIZMAMA GRUPE
     1ELEMENATA',I6/1X,69('-')///
     3' ELEME   CVOR1 CVOR2 CVOR3 CVOR4 CVOR5 CVOR6     MATER KOORD NAPO
     1N NAPON KORAK'/'  BROJ',44X,A4,' STAMP STAMP CVORA GENER'/7X,
     1' CVOR7 CVOR8 CVOR9 CVO10 CVO11 CVO12 CVO13 CVO14 CVO15')
 2200 FORMAT(///' UCITANI PODACI O ELEMENTIMA CETVOROSTRANIM PIRAMIDAMA 
     1GRUPE ELEMENATA',I6/1X,75('-')///
     3' ELEME   CVOR1 CVOR2 CVOR3 CVOR4 CVOR5           MATER KOORD NAPO
     1N NAPON KORAK'/'  BROJ',44X,A4,' STAMP STAMP CVORA GENER'/7X,
     1' CVOR6 CVOR7 CVOR8 CVOR9 CVO10 CVO11 CVO12 CVO13')
 2300 FORMAT(///' UCITANI  PODACI  O  TETRAEDARSKIM  ELEMENTIMA  GRUPE  
     1ELEMENATA',I6/1X,69('-')///
     3' ELEME   CVOR1 CVOR2 CVOR3 CVOR4                 MATER KOORD NAPO
     1N NAPON KORAK'/'  BROJ',44X,A4,' STAMP STAMP CVORA GENER'/7X,
     1' CVOR5 CVOR6 CVOR7 CVOR8 CVOR9 CVO10')
 2140 FORMAT(' GENERISANI PODACI O IZOPARAMETARSKIM 3/D ELEMENTIMA GRUPE
     1 ELEMENATA',I6/1X,73('-')///
     3' ELEME  CVO1 CVO2 CVO3 CVO4 CVO5 CVO6 CVO7 CVO8  MATER KOORD NAPO
     1N NAPON'/'  BROJ',44X,A4,' STAMP STAMP CVORA'/7X,                ' 
     1CVO9 CV10 CV11 CV12 CV13 CV14 CV15 CV16 CV17 CV18 CV19 CV20 CV21')
 2240 FORMAT(' GENERISANI PODACI O ELEMENTIMA TROSTRANIM PRIZMAMA GRUPE
     1ELEMENATA',I6/1X,72('-')///
     3' ELEME   CVOR1 CVOR2 CVOR3 CVOR4 CVOR5 CVOR6     MATER KOORD NAPO
     1N NAPON'/'  BROJ',44X,A4,' STAMP STAMP CVORA'/7X,
     1' CVOR7 CVOR8 CVOR9 CVO10 CVO11 CVO12 CVO13 CVO14 CVO15')
 2340 FORMAT(' GENERISANI PODACI O ELEMENTIMA CETVOROSTRANIM PIRAMIDAMA 
     1GRUPE ELEMENATA',I6/1X,78('-')///
     3' ELEME   CVOR1 CVOR2 CVOR3 CVOR4 CVOR5           MATER KOORD NAPO
     1N NAPON'/'  BROJ',44X,A4,' STAMP STAMP CVORA'/7X,
     1' CVOR6 CVOR7 CVOR8 CVOR9 CVO10 CVO11 CVO12 CVO13')
 2440 FORMAT(' GENERISANI  PODACI  O  TETRAEDARSKIM  ELEMENTIMA  GRUPE  
     1ELEMENATA',I6/1X,72('-')///
     3' ELEME   CVOR1 CVOR2 CVOR3 CVOR4                 MATER KOORD NAPO
     1N NAPON'/'  BROJ',44X,A4,' STAMP STAMP CVORA'/7X,
     1' CVOR5 CVOR6 CVOR7 CVOR8 CVOR9 CVO10')
 2110 FORMAT(///' IZMEDJU ELEMENATA N1=',I5,' I N2=',I5,' NEMA NG=',I5,
     1' ELEMENATA KOJE TRBA GENERISATI')
 2120 FORMAT(///' BROJ CVORA N2=',I5,' NE MOZE SE DOBITI SABIRANJEM BROJ
     1A CVORA N1=',I5,' I KONACNOG BROJA KORAKA KORA=',I5)
 2500 FORMAT(///6X,' U C I T A N I    P O D A C I   O   V I S E S L O J 
     1N I M    S E T O V I M A    M A T E R I J A L A'/6X,99('-')///)
 2505 FORMAT(///' BROJ SLOJEVA U MATERIJALNOM SETU MORA BITI VECI OD 0'/
     1' (MAKSIMALNO :     MSLOJ )')
 2530 FORMAT(//10X,'MATERIJALNI SET (',I3,') ',5X,'BROJ SLOJEVA =',I3/)
 2540 FORMAT(/10X,'SLOJ =',I3/10X,'MATERIJAL =',I3/10X,'RELATIVNA ',
     1'DEBLJINA =',1PD10.3/10X,'UGAO VLAKANA =',1PD10.3) 
 2550 FORMAT(/// ' ZBIR RELATIVNIH DEBLJINA SLOJEVA U MATERIJALNOM SETU 
     1MORA BITI   1.00'/' (KONTROLNI ZBIR JE :   TTT =',1PD10.3)
 2040 FORMAT(' VREME NASTAJANJA ELEMENTA - TBTH =',1PD10.3)
 2050 FORMAT(' VREME NESTAJANJA ELEMENTA - TDTH =',1PD10.3)
C-----------------------------------------------------------------------
 6000 FORMAT(///' READING DATA ABOUT ISOPARAMETRIC 3/D ELEMENTS FOR GROU
     1P',I6/1X,61('-')///
     3' ELEME  NOD1 NOD2 NOD3 NOD4 NOD5 NOD6 NOD7 NOD8  MATER COORD STRE
     1S STRES  STEP'/' NUMBE',44X,A4,' PRINT PRINT  NODE GENER'/7X,    ' 
     1NOD9 NO10 NO11 NO12 NO13 NO14 NO15 NO16 NO17 NO18 NO19 NO20 NO21')
 6100 FORMAT(///' READING DATA ABOUT TO PRISMATIC ELEMENTS FOR GROUP',I6
     1/1X,56('-')///
     3' ELEME   NODE1 NODE2 NODE3 NODE4 NODE5 NODE6     MATER COORD STRE
     1S STRES  STEP'/' NUMBE',44X,A4,' PRINT PRINT  NODE GENER'/7X,
     1' NODE7 NODE8 NODE9 NOD10 NOD11 NOD12 NOD13 NOD14 NOD15')
 6200 FORMAT(///' READING DATA ABOUT TO PYRAMIDAL ELEMENTS FOR GROUP',I6
     1/1X,56('-')///
     3' ELEME   NODE1 NODE2 NODE3 NODE4 NODE5           MATER COORD STRE
     1S STRES  STEP'/' NUMBE',44X,A4,' PRINT PRINT  NODE GENER'/7X,
     1' NODE6 NODE7 NODE8 NODE9 NOD10 NOD11 NOD12 NOD13')
 6300 FORMAT(///' READING DATA ABOUT TO TETRAHEDRONAL ELEMENTS FOR GROUP
     1',I6/1X,60('-')///
     3' ELEME   NODE1 NODE2 NODE3 NODE4                 MATER COORD STRE
     1S STRES  STEP'/' NUMBE',44X,A4,' PRINT PRINT  NODE GENER'/7X,
     1' NODE5 NODE6 NODE7 NODE8 NODE9 NOD10')
 6140 FORMAT (' GENERATED DATA ABOUT TO ISOPARAMETRIC 3/D ELEMENTS FOR G
     1ROUP',I6/1X,66('-')///
     3' ELEME  NOD1 NOD2 NOD3 NOD4 NOD5 NOD6 NOD7 NOD8  MATER COORD STRE
     1S STRES'/' NUMBE',44X,A4,' PRINT PRINT  NODE'/7X,                ' 
     1NOD9 NO10 NO11 NO12 NO13 NO14 NO15 NO16 NO17 NO18 NO19 NO20 NO21')
 6240 FORMAT (' GENERATED DATA ABOUT TO PRISMATIC ELEMENTS FOR GROUP',I6
     1/1X,58('-')///
     3' ELEME   NODE1 NODE2 NODE3 NODE4 NODE5 NODE6     MATER COORD STRE
     1S STRES'/' NUMBE',44X,A4,' PRINT PRINT  NODE'/7X,
     1' NODE7 NODE8 NODE9 NOD10 NOD11 NOD12 NOD13 NOD14 NOD15')
 6340 FORMAT (' GENERATED DATA ABOUT TO PYRAMIDAL ELEMENTS FOR GROUP',I6
     1/1X,58('-')///
     3' ELEME   NODE1 NODE2 NODE3 NODE4 NODE5           MATER COORD STRE
     1S STRES'/' NUMBE',44X,A4,' PRINT PRINT  NODE'/7X,
     1' NODE6 NODE7 NODE8 NODE9 NOD10 NOD11 NOD12 NOD13')
 6440 FORMAT (' GENERATED DATA ABOUT TO TETRAHEDRONAL ELEMENTS FOR GROUP
     1',I6/1X,62('-')///
     3' ELEME   NODE1 NODE2 NODE3 NODE4                 MATER COORD STRE
     1S STRES'/' NUMBE',44X,A4,' PRINT PRINT  NODE'/7X,
     1' NODE5 NODE6 NODE7 NODE8 NODE9 NOD10')
 6110 FORMAT(///' IZMEDJU ELEMENATA N1=',I5,' I N2=',I5,' NEMA NG=',I5,
     1' ELEMENATA KOJE TRBA GENERISATI')
 6120 FORMAT(///' BROJ CVORA N2=',I5,' NE MOZE SE DOBITI SABIRANJEM BROJ
     1A CVORA N1=',I5,' I KONACNOG BROJA KORAKA KORA=',I5)
 6500 FORMAT(///6X,' R E A D I N G    D A T A    A B O U T    M U L T I 
     1L A Y E R E D    M A T E R I A L    S E T S'/6X,93('-')///)
 6505 FORMAT(///' NUMBER OF LAYERS IN MATERIAL SET MUST BE GREATER',
     1          ' THAN   0'/' (MAXIMUM :     MSLOJ )')
 6530 FORMAT(//10X,'MATERIAL SET (',I3,') ',5X,'NUMBER OF LAYERS =',I3/)
 6540 FORMAT(/10X,'LAYER =',I3/10X,'MATERIAL =',I3/10X,'RELATIV ',
     1'THICKNESS =',1PD10.3/10X,'FIBER ANGLE =',1PD10.3) 
 6550 FORMAT(/// ' RELATIV THICKNESSES SUM IN MATERIAL SET MUST BE', 
     1'   1.00'/' (CONTROL SUM IS :   TTT =',1PD10.3)
 6040 FORMAT(' ELEMENT BIRTH TIME - TBTH =',1PD10.3)
 6050 FORMAT(' ELEMENT DEATH TIME - TDTH =',1PD10.3)
C-----------------------------------------------------------------------
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE LM3MHT(ID,NEL,LMEL,ND)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C .......................................................................
C .
CE.   P R O G R A M
CE.       TO FORM VECTOR LM AND HEIGHT OF COLUMNS
CS.   P R O G R A M
CS.       ZA FORMIRANJE VEKTORA LM I VISINA STUBOVA MATRICE KRUTOSTI
C .
C .......................................................................
C
      include 'paka.inc'
      
      COMMON /GLAVNI/ NP,NGELEM,NMATM,NPER,
     1                IOPGL(6),KOSI,NDIN,ITEST
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /REPERI/ LCORD,LID,LMAXA,LMHT
      COMMON /GEORGE/ TOLG,ALFAG,ICCGG
      COMMON /DRAKCE/ IDRAKCE,NELUK,NZERO,NEED1,NEED2,NEED3,NNZERO
     1                ,IROWS,LAILU,LUCG,LVCG,LWCG,LPCG,LRCG
      COMMON /CDEBUG/ IDEBUG
      DIMENSION ID(NP,*),NEL(NE,*),LMEL(ND,*)
     
C
      IF(IDEBUG.GT.0) PRINT *, ' LM3MHT'
CE    LOOP OVER ELEMENTS
CS    PETLJA PO ELEMENTIMA
      DO 100 NLM=1,NE
      DO 10 NC=1,NCVE                            
      IF(NEL(NLM,NC).EQ.0) GO TO 10              
      NNC=3*(NC-1)                               
      JJ=NEL(NLM,NC)                             
      DO 20 I=1,3                                
   20 LMEL(NNC+I,NLM)=ID(JJ,I)                   
   10 CONTINUE                                   
C
CE    FORM HEIGHT COLUMNS
CS    FORMIRANJE VISINA STUBOVA
C
      CALL VISINE(A(LMHT),ND,LMEL(1,NLM))
      IF (IABS(ICCGG).EQ.1) THEN
         WRITE(IDRAKCE) ND,(LMEL(I,NLM),I=1,ND)
         NELUK=NELUK+1
      ENDIF
  100 CONTINUE
      RETURN
      END
C=====================================================================
      SUBROUTINE TGRAF3(NEL,MCVEL,ICVEL,NMAT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C .......................................................................
C .
CE.   P R O G R A M
CE.       TO PRINTOUT 3/D ELEMENTS DATA IN UNIVERSAL GRAPHICS FILE
CS.   P R O G R A M
CS.       ZA STAMPANJE 3/D ELEMENATA U UNIVERZALNI FILE
C .
C .......................................................................
C 
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /TRAKEJ/ IULAZ,IZLAZ,IELEM,ISILE,IRTDT,IFTDT,ILISK,ILISE,
     1                ILIMC,ILDLT,IGRAF,IDINA,IPOME,IPRIT,LDUZI
      COMMON /SUMELE/ ISUMEL,ISUMGR
      COMMON /SRPSKI/ ISRPS
      COMMON /NIDEAS/ IDEAS
      COMMON /PODTIP/ IPODT
      DIMENSION NEL(NE,*),MCVEL(*),NMAT(*)
      DIMENSION FIZ(14)         
      COMMON /CDEBUG/ IDEBUG
C
      IF(IDEBUG.GT.0) PRINT *, ' TGRAF3'
      IF(ideas.eq.-1) return
      if(IPODT.EQ.3) RETURN
      ISUMGR=ISUMGR+1
C
C     FIZICKE OSOBINE
C
      NULA=0
      ZERO=0.
      ONE=1.
      JEDAN=1
      INDPR=25
      INDPD=2
      I11=11
      I2=2
      I4=4
      I8=8
      I14=14
      I48=48
C
      CALL CLEAR(FIZ,12)
      ICL=1
      IPH=110
      NPR=4
      KCL=14
      IF(IDEAS.GT.6) THEN
         KLC=4
         NPR=2
      ENDIF
      IND=-1
      IF(IDEAS.GT.6) THEN
        ITYP=2437
      ELSE
        ITYP=772
      ENDIF
      WRITE(IGRAF,1100) IND
      WRITE(IGRAF,1100) ITYP
      WRITE(IGRAF,1000) ISUMGR,IPH,NPR
      IF(ISRPS.EQ.0)
     1WRITE(IGRAF,2000) ISUMGR
      IF(ISRPS.EQ.1)
     1WRITE(IGRAF,6000) ISUMGR
      IF(IDEAS.GT.6) THEN
         IF(NPR.GT.0) THEN
            WRITE(IGRAF,1000) JEDAN,I2,I4
            WRITE(IGRAF,1200) (FIZ(I),I=ICL,I4)
         ENDIF
         IF(NPR.GT.1) THEN
            WRITE(IGRAF,1000) I48,I2,JEDAN
            WRITE(IGRAF,1200) (FIZ(5))
         ENDIF
      ELSE
         WRITE(IGRAF,1200) (FIZ(I),I=ICL,KCL)
      ENDIF
      WRITE(IGRAF,1100) IND
C
C     M A T E R I J A L I
C
      MAT=NMAT(1)
      IF(IDEAS.LT.7) CALL MELGR(MAT)
C
C     E L E M E N T I
C
      IF(ISRPS.EQ.0.AND.(NCVE.NE.8.AND.NCVE.NE.20))
     1WRITE(IZLAZ,2200) NGE,ncve
      IF(ISRPS.EQ.1.AND.(NCVE.NE.8.AND.NCVE.NE.20))
     1WRITE(IZLAZ,6200) NGE,ncve
      NNCVE=NCVE
      IF(NCVE.LT.20) NCVE=8
      IF(NCVE.EQ.21) NCVE=20
      IF(NGAUSX.NE.9.AND.(NGAUSX.NE.NGAUSY.OR.NGAUSX.NE.NGAUSZ))
     1 GO TO 160
C     GRAFICKI OPIS ELEMENTA: SA 8 CVOROVA = 19, SA 20 CVOROVA = 20
      IFGD=19
      IF(NCVE.EQ.20) IFGD=20
C     VRSTA 3/D ELEMENTA: SA 8 CVOROVA = 115, SA 20 CVOROVA = 116
      IFDI=115
      IF(NCVE.EQ.20) IFDI=116
C     TABELA FIZICKIH OSOBINA
      IPTN=ISUMGR
C     TABELA MATERIJALA
      IF(IDEAS.LT.7) THEN
         MPTN=ISUMGR
      ELSE
         MPTN=MAT
      ENDIF         
C     BOJA  
      ICOL=7
C     BROJ CVOROVA NA ELEMENTU
      NNODS=NCVE
      IND=-1
      IF(IDEAS.GT.6) THEN
         ITYP=2412
      ELSEIF(IDEAS.EQ.6) THEN
         ITYP=780
         ICOL=11
      ELSE
         ITYP=71
      ENDIF
      WRITE(IGRAF,1100) IND
      WRITE(IGRAF,1100) ITYP
      DO 10 I=1,NE
C        REDNI BROJ ELEMENTA
         IEL=I+ISUMEL
         IF(ICVEL.EQ.1) IEL=MCVEL(I)
         IF(IDEAS.GT.6) THEN
            WRITE(IGRAF,1000) IEL,IFDI,IPTN,MPTN,ICOL,NNODS
         ELSEIF(IDEAS.EQ.6) THEN
            WRITE(IGRAF,1000) IEL,IFDI,JEDAN,IPTN,MPTN,JEDAN,ICOL,NNODS
         ELSE
            WRITE(IGRAF,1000) IEL,IFGD,IFDI,IPTN,MPTN,ICOL,NNODS
         ENDIF
         IF(NCVE.EQ.8) THEN
            WRITE(IGRAF,1000) (NEL(I,J),J=1,8)
         ELSE
            WRITE(IGRAF,1000) (NEL(I,J),NEL(I,J+8),J=1,4),
     1                    (NEL(I,J),J=17,20),(NEL(I,J),NEL(I,J+8),J=5,8)
         ENDIF
   10 CONTINUE
      WRITE(IGRAF,1100) IND
      ISUMEL=ISUMEL+NE
      NCVE=NNCVE
      RETURN
C
  160 CONTINUE
      IF(ISRPS.EQ.0)
     1WRITE(IZLAZ,2160) NGE
      IF(ISRPS.EQ.1)
     1WRITE(IZLAZ,6160) NGE
      STOP
C
 1000 FORMAT(8I10)
 1100 FORMAT(I6)
 1200 FORMAT(6(1PE13.5))
C-----------------------------------------------------------------------
 2000 FORMAT('FIZICKI SET :',I10)
 2160 FORMAT(//' ZBOG GRAFIKE U GRUPI ELEMENATA NGE =',I5/
     1' GAUSOVA INTEGRACIJA U SVA TRI PRAVCA MORA BITI ISTOG REDA')
 2200 FORMAT(//' PROGRAM ZA GRAFICKO PRIKAZIVANJE REZULTATA "IDEAS"'/
     1' ZAHTEVA 3/D ELEMENT SA 8 ILI 20 CVOROVA U GRUPI ELEMENATA NGE ='
     1,I5,'    NCVE =',I5)
C-----------------------------------------------------------------------
 6000 FORMAT('PHISICAL PROPERTIES SET :',I10)
 6160 FORMAT(//' FOR GRAPHIC OUTPUT FOR ELEMENT GROUP  NGE =',I5/
     1' GAUSS INTEGRATION IN (R),(S) AND (T) DIRECTION MUST BE SAME')
 6200 FORMAT(//' GRAPHIC PACKAGE   "IDEAS"'/
     1' PERMITS ONLY 3/D ELEMENTS WITH 8 OR 20 NODES PER ELEMENT IN',
     1' GROUP   NGE =',I5,'    NCVE =',I5)
C-----------------------------------------------------------------------
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE JEDVEK(NEL,TSGE)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C ......................................................................
C .
CE.   P R O G R A M
CS.   P R O G R A M
C .
C ......................................................................
C
      CHARACTER*6 IMD
      include 'paka.inc'
      
      COMMON /ELEMAU/ MXAU,LAU,LLMEL,LNEL,LNMAT,LTHID,LIPGC,LIPRC,LISNA,
     1 LMXAU,LAPRS
      COMMON /ELEIND/ NGAUSX,NGAUSY,NGAUSZ,NCVE,ITERME,MAT,IETYP
      COMMON /ELEALL/ NETIP,NE,IATYP,NMODM,NGE,ISKNP,LMAX8
      COMMON /REPERI/ LCORD,LID,LMAXA,LMHT
      COMMON /ELEMEN/ ELAST(6,6),XJ(3,3),ALFA(6),TEMP0,DET,NLM,KK
      COMMON /ORIENT/ CPP(3,3),XJJ(3,3),TSG(6,6),BETA,LBET0,IBB0
      COMMON /UCORIJ/ IORT
      DIMENSION NEL(NE,*),TSGE(6,6,*),HE(84),CX(3,3),TBETA(6,6)
      COMMON /CDEBUG/ IDEBUG
C
      IF(IDEBUG.GT.0) PRINT *, 'JEDVEK'
      IF(IORT.EQ.1) THEN
         IDIS=79
         IMD='PRAVCI'
         OPEN (IDIS,FILE=IMD,STATUS='OLD',FORM='FORMATTED',
     1         ACCESS='SEQUENTIAL')
      ENDIF
      R=0.D0
      S=0.D0
      T=0.D0
      IF(IBB0.EQ.0) CALL STBETA(TBETA,BETA)
      DO 10 NLM=1,NE
         CALL JACTE3(NEL,A(LCORD),HE,R,S,T,0)
         CALL TRANAL(XJJ,TSG,IBB0)
         IF(IBB0.EQ.0) THEN
            IF(IORT.EQ.0) THEN
               CALL MNOZM1(TSGE(1,1,NLM),TBETA,TSG,6,6,6)
            ELSE
               READ(IDIS,*) ((CX(I,J),J=1,3),I=1,3)
               CALL TRANSE(TSGE(1,1,NLM),CX)
            ENDIF
         ENDIF
         IF(IBB0.EQ.1) THEN
           CX(1,1)=CPP(1,1)*XJJ(1,1)+CPP(1,2)*XJJ(1,2)+CPP(1,3)*XJJ(1,3)
           CX(1,2)=CPP(1,1)*XJJ(2,1)+CPP(1,2)*XJJ(2,2)+CPP(1,3)*XJJ(2,3)
           CX(1,3)=CPP(1,1)*XJJ(3,1)+CPP(1,2)*XJJ(3,2)+CPP(1,3)*XJJ(3,3)
           CX(2,1)=CPP(2,1)*XJJ(1,1)+CPP(2,2)*XJJ(1,2)+CPP(2,3)*XJJ(1,3)
           CX(2,2)=CPP(2,1)*XJJ(2,1)+CPP(2,2)*XJJ(2,2)+CPP(2,3)*XJJ(2,3)
           CX(2,3)=CPP(2,1)*XJJ(3,1)+CPP(2,2)*XJJ(3,2)+CPP(2,3)*XJJ(3,3)
           CX(3,1)=CPP(3,1)*XJJ(1,1)+CPP(3,2)*XJJ(1,2)+CPP(3,3)*XJJ(1,3)
           CX(3,2)=CPP(3,1)*XJJ(2,1)+CPP(3,2)*XJJ(2,2)+CPP(3,3)*XJJ(2,3)
           CX(3,3)=CPP(3,1)*XJJ(3,1)+CPP(3,2)*XJJ(3,2)+CPP(3,3)*XJJ(3,3)
           CALL TRANAL(CX,TSGE(1,1,NLM),2)
         ENDIF
   10 CONTINUE
      IF(IORT.EQ.1) CLOSE(IDIS)
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE ZADA3B(TAU,NE,NGS12,MXS,NLD)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C ......................................................................
C .
CE.   P R O G R A M
CE.      TO INITIAL VALUE MATRIX - B
CS.   P R O G R A M
CS.      ZA ZADAVANJE POCETNE JEDINICNE VREDNOSTI ZA MATRICU - B
C .
C ......................................................................
C
      DIMENSION TAU(NLD,NGS12,NE,*)
C
      DO 10 J=1,MXS
      DO 10 I=1,NE
         DO 20 K=1,NGS12
            IF(NLD.EQ.6) THEN
               TAU(1,K,I,J)=1.D0
               TAU(2,K,I,J)=1.D0
               TAU(3,K,I,J)=1.D0
            ELSE
               TAU(1,K,I,J)=1.D0
               TAU(5,K,I,J)=1.D0
               TAU(9,K,I,J)=1.D0
            ENDIF
   20    CONTINUE
   10 CONTINUE
      RETURN
      END
C=====================================================================
      SUBROUTINE NAJKRA(NEL,NNOD,MCVEL,NCVEL,ICVEL,CORD,NP,NE,IZLAZ)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      DIMENSION NEL(NE,*),MCVEL(*),NCVEL(*),CORD(NP,*),NNOD(*),DXYZ(3)
	TRI=3.
      ELMIN=1.E9
      ELMAX=0.
      DO NLM=1,NE
         ELMI=1.E9
         ELMA=0.
         NCVE=NNOD(NLM)
         DO I=1,NCVE
         DO J=I+1,NCVE
            N1=NEL(NLM,I)
            N2=NEL(NLM,J)
            IF(N1.NE.N2) THEN
               DO K=1,3
                  DXYZ(K)=CORD(N1,K)-CORD(N2,K)
               ENDDO
               EL=RNORM(DXYZ,3)
               IF(EL.GT.ELMA) ELMA=EL
               IF(EL.LT.ELMI) ELMI=EL
               IF(EL.LT.ELMIN) THEN
                  ELMIN=EL
                  IF(ICVEL.EQ.1) THEN
                     NMIN1=NCVEL(N1)
                     NMIN2=NCVEL(N2)
                     NMINE=MCVEL(NLM)
                  ELSE
                     NMIN1=N1
                     NMIN2=N2
                     NMINE=NLM
                  ENDIF
               ENDIF
            ENDIF
         ENDDO
	   ENDDO
         STRETCH=ELMI/ELMA*DSQRT(TRI)
         IF(STRETCH.LE.0.25) THEN
            NL=NLM
            IF(ICVEL.EQ.1) NL=MCVEL(NLM)
            WRITE(IZLAZ,1000) NL,STRETCH
         ENDIF
      ENDDO
      WRITE(IZLAZ,2000) NMIN1,NMIN2,NMINE,ELMIN
      RETURN
 1000 FORMAT(' ELEMENT=',I8,'  STRETCH=',F7.4,' < 0.25')
 2000 FORMAT(//' MINIMAL DISTANCE BETWEEN NODES',I8,' AND',I8,
     1         ' IN ELEMENT',I8,' IS DISTANCE=',1PE12.5)
      END
